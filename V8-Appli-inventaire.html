<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Pro - Gestion Intelligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4a8b4;
            --primary-light: #f9f0f3;
            --primary-dark: #b87c8f;
            --secondary: #10b981;
            --secondary-light: #d1fae5;
            --accent: #f59e0b;
            --background: #fefaf9;
            --surface: #ffffff;
            --text-primary: #2d1b1f;
            --text-secondary: #6b4a52;
            --text-muted: #9c7a83;
            --border: #f0e1e5;
            --border-light: #faf5f6;
            --danger: #e56b6b;
            --danger-light: #fdf0f0;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 6px;
            --radius: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --primary: #d4a8b4;
            --primary-light: #3a252a;
            --primary-dark: #e8c3ce;
            --secondary: #34d399;
            --secondary-light: #065f46;
            --accent: #fbbf24;
            --background: #1a1014;
            --surface: #2a1a1f;
            --text-primary: #f7eef0;
            --text-secondary: #e8c3ce;
            --text-muted: #b87c8f;
            --border: #3a252a;
            --border-light: #2a1a1f;
            --danger: #f87171;
            --danger-light: #7f1d1d;
            --success: #34d399;
            --warning: #fbbf24;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--transition);
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            margin: 0 0 0.5rem;
            font-weight: 800;
            position: relative;
        }

        header p {
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.9;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 420px 1fr;
                align-items: flex-start;
            }
        }

        .card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            padding: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.75rem;
            margin: 0 0 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }
        .card-title svg { 
            width: 28px; 
            height: 28px; 
            color: var(--primary); 
        }

        .form-section {
            position: sticky;
            top: 2rem;
        }

        .form-grid { 
            display: grid; 
            gap: 1.5rem; 
        }
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--surface);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* Styled File Input */
        .file-upload-wrapper {
            position: relative;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--background);
        }
        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%; 
            height: 100%;
            top: 0; 
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-text { 
            color: var(--text-secondary); 
        }
        .file-upload-text span { 
            color: var(--primary); 
            font-weight: 600; 
        }
        
        .photo-preview {
            margin-top: 1rem;
            border-radius: var(--radius);
            overflow: hidden;
            max-width: 180px;
            display: none;
            box-shadow: var(--shadow-md);
        }
        .photo-preview img { 
            display: block; 
            width: 100%; 
            height: auto;
        }
        
        .form-actions { 
            display: flex; 
            gap: 0.75rem; 
            justify-content: flex-end; 
            margin-top: 1.5rem; 
        }

        button {
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button.primary {
            background: linear-gradient(135deg, #f97316, #ec4899);
            color: white;
            box-shadow: var(--shadow-md);
        }
        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        button.secondary { 
            background-color: var(--border-light); 
            color: var(--text-primary); 
        }
        button.secondary:hover { 
            background-color: var(--border); 
        }
        
        .dashboard-grid {
            display: grid;
            gap: 2rem;
        }

        .mobile-filters-toggle {
            display: none;
            align-items: center;
            gap: 0.5rem;
            border-radius: var(--radius);
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            font-weight: 600;
            width: 100%;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .mobile-filters-toggle svg {
            width: 18px;
            height: 18px;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filters.collapsed {
            display: none;
        }

        .quick-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .quick-filter-btn {
            flex: 1 1 auto;
            min-width: 120px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-secondary);
            padding: 0.6rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .quick-filter-btn.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .table-wrapper { 
            overflow-x: auto; 
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.95rem; 
        }
        th, td { 
            padding: 1rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            vertical-align: middle; 
        }
        thead { 
            background-color: var(--background); 
        }
        tbody tr:nth-child(odd) { 
            background-color: var(--surface); 
        }
        tbody tr:nth-child(even) { 
            background-color: var(--background); 
        }
        tbody tr:hover { 
            background-color: var(--primary-light); 
        }

        .thumbnail { 
            width: 60px; 
            height: 60px; 
            border-radius: var(--radius-sm); 
            object-fit: cover; 
            box-shadow: var(--shadow-sm); 
        }
        
        .status {
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            padding: 6px 12px;
            border-radius: 999px; 
            font-size: 0.85rem; 
            font-weight: 600;
        }
        .status.on-sale { 
            background-color: var(--secondary-light); 
            color: var(--success); 
        }
        .status.sold { 
            background-color: var(--border-light); 
            color: var(--text-muted); 
        }

        .actions-cell { 
            display: flex; 
            gap: 0.5rem; 
        }
        .actions-cell button {
            background: none; 
            border: 1px solid var(--border); 
            border-radius: 50%;
            width: 36px; 
            height: 36px; 
            padding: 0;
            color: var(--text-secondary);
        }
        .actions-cell button:hover { 
            background-color: var(--background); 
            color: var(--text-primary); 
        }
        .actions-cell button.delete:hover { 
            background-color: var(--danger-light); 
            color: var(--danger); 
        }
        .actions-cell button svg { 
            width: 16px; 
            height: 16px; 
        }

        .empty-state { 
            text-align: center; 
            padding: 3rem; 
            color: var(--text-secondary); 
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 1.5rem; 
        }
        .stat-card {
            background: linear-gradient(135deg, var(--surface), var(--background));
            border-radius: var(--radius); 
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        .stat-card h3 { 
            margin: 0 0 0.5rem; 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .stat-card svg { 
            width: 16px; 
            height: 16px; 
        }
        .stat-card .value { 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: var(--text-primary); 
        }

        /* Modal Styles */
        .modal {
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.6);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100;
            opacity: 0; 
            visibility: hidden; 
            transition: var(--transition);
            padding: 1rem;
        }
        .modal.visible { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content {
            background: var(--surface); 
            padding: 2rem; 
            border-radius: var(--radius-lg);
            width: min(450px, 90vw); 
            box-shadow: var(--shadow-xl); 
            position: relative;
            transform: translateY(20px) scale(0.95); 
            transition: var(--transition);
        }
        .modal.visible .modal-content { 
            transform: translateY(0) scale(1); 
        }
        .modal-content h3 { 
            margin-top: 0; 
            font-family: 'Poppins', serif; 
            font-size: 1.5rem;
        }
        .close-modal {
            position: absolute; 
            top: 1rem; 
            right: 1rem;
            background: none; 
            border: none; 
            font-size: 1.5rem;
            cursor: pointer; 
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover {
            background-color: var(--background);
        }
        
        .spinner {
            width: 16px; 
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border { 
            to { 
                transform: rotate(360deg); 
            } 
        }

        .ai-processing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .ai-processing.hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            background-color: var(--surface);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        /* Styles pour les plateformes de vente */
        .platform-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .platform-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            background-color: var(--border-light);
            color: var(--text-secondary);
        }

        .platform-tag.sold {
            border: 1px solid var(--success);
            background-color: var(--secondary-light);
            color: var(--success);
        }

        .platform-tag.vinted {
            background-color: #f5f5f5;
            color: #4a90e2;
        }

        .platform-tag.leboncoin {
            background-color: #f5f5f5;
            color: #ff6b00;
        }

        .platform-tag.ebay {
            background-color: #f5f5f5;
            color: #e53238;
        }

        .platform-tag.autre {
            background-color: var(--border-light);
            color: var(--text-secondary);
        }

        .platform-price {
            font-weight: 600;
            margin-left: 0.25rem;
        }

        .platform-fees {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Modal pour gérer les plateformes de vente */
        .platform-modal .modal-content {
            width: min(600px, 90vw);
        }

        .platform-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .platform-form .form-group {
            margin-bottom: 0;
        }

        .platform-form .form-group.full-width {
            grid-column: 1 / -1;
        }

        .price-suggestion {
            grid-column: 1 / -1;
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px dashed var(--primary);
            color: var(--text-secondary);
        }

        .price-suggestion strong {
            color: var(--text-primary);
        }

        .price-suggestion button {
            align-self: flex-start;
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }

        .platform-list-modal {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .platform-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--radius);
            background-color: var(--background);
            border: 1px solid var(--border);
        }

        .platform-item-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .platform-item-status {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--success);
        }

        .platform-item-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .platform-item-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .platform-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .platform-item-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            width: auto;
            height: auto;
            border-radius: var(--radius-sm);
        }

        .sale-details {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .insights-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .insight-card {
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            box-shadow: var(--shadow-sm);
        }

        .insight-card .insight-title {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .insight-card .insight-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .mobile-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            display: none;
            justify-content: space-around;
            padding: 0.6rem 0.5rem env(safe-area-inset-bottom);
            z-index: 950;
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .mobile-action-bar {
            background: rgba(26, 16, 20, 0.92);
        }

        .mobile-action-bar button {
            flex: 1;
            border-radius: var(--radius);
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--border-light);
        }

        .mobile-action-bar button.primary-action {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
        }

        .mobile-action-bar button svg {
            width: 18px;
            height: 18px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .form-section .form-actions {
                position: sticky;
                bottom: calc(96px + env(safe-area-inset-bottom));
                margin: 1.5rem -1.5rem -1.5rem;
                padding: 1rem 1.5rem env(safe-area-inset-bottom);
                background: var(--surface);
                border-top: 1px solid var(--border);
                box-shadow: 0 -12px 30px rgba(0, 0, 0, 0.12);
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
                z-index: 940;
            }

            .form-section .form-actions button {
                width: 100%;
            }

            .form-section .form-actions button.primary {
                font-size: 1.05rem;
                padding: 0.9rem 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .platform-form {
                grid-template-columns: 1fr;
            }

            .mobile-action-bar {
                display: flex;
            }

            .mobile-filters-toggle {
                display: inline-flex;
            }

            .filters.collapsed {
                display: none;
            }

            .filters.open {
                display: grid;
                grid-template-columns: 1fr;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead {
                display: none;
            }

            tbody tr {
                margin-bottom: 1rem;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                background: var(--surface);
                box-shadow: var(--shadow-sm);
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
                border-bottom: 1px solid var(--border);
                padding: 0.85rem 1rem;
            }

            td:last-child {
                border-bottom: none;
            }

            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-secondary);
                flex: 1 0 45%;
                text-align: left;
            }

            td > * {
                flex: 1 0 55%;
            }

            .actions-cell {
                justify-content: flex-start;
            }

            .actions-cell button {
                width: 42px;
                height: 42px;
            }

            body {
                padding-bottom: 80px;
            }
        }

    </style>
</head>
<body>
    <header>
        <button class="theme-toggle" id="themeToggle" aria-label="Basculer le mode sombre">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
        <h1>Inventaire Pro</h1>
        <p>Votre assistant intelligent pour la gestion de trésors et d'objets de collection.</p>
    </header>

    <main class="container">
        <section class="form-section card">
            <h2 class="card-title" id="formTitle">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Ajouter un objet
            </h2>
            <form id="itemForm">
                <input type="hidden" id="editItemId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="photo">Photo</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="photo" accept="image/*">
                            <div class="file-upload-text">
                                <p>Glissez-déposez une image ou <br><span>cliquez pour parcourir</span></p>
                            </div>
                        </div>
                        <div class="photo-preview" id="photoPreviewContainer">
                            <img id="photoPreview" alt="Prévisualisation">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="titre">Titre de l'objet</label>
                        <input type="text" id="titre" placeholder="Généré via l'IA..." required>
                        <div class="ai-processing hidden" id="aiProcessing">
                            <span class="spinner"></span>
                            <span>Analyse de l'image en cours...</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="casier">Casier / Emplacement</label>
                        <input type="text" id="casier" placeholder="Ex: A1, Bx1" required>
                    </div>
                    <div class="form-group">
                        <label for="prixAchat">Prix d'achat (€)</label>
                        <input type="number" id="prixAchat" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="dateAchat">Date d'achat</label>
                        <input type="date" id="dateAchat" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (facultatif)</label>
                        <textarea id="notes" rows="3" placeholder="État, provenance..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" id="cancelEditBtn" hidden>Annuler</button>
                    <button type="submit" class="primary" id="submitBtn">Ajouter à l'inventaire</button>
                </div>
            </form>
        </section>

        <section class="dashboard-grid">
            <div class="card" id="statsCard">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    Statistiques
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                            </svg> 
                            En stock
                        </h3>
                        <div class="value" id="statEnStock">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                            </svg> 
                            Vendus
                        </h3>
                        <div class="value" id="statVendus">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                            </svg> 
                            C.A.
                        </h3>
                        <div class="value" id="statCA">0 €</div>
                    </div>
                    <div class="stat-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg> 
                            Marge
                        </h3>
                        <div class="value" id="statMarge">0 €</div>
                    </div>
                </div>
            </div>
            <div class="card" id="platformInsightsCard" hidden>
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v5.25M3 8.25A2.25 2.25 0 0 0 5.25 10.5H19.5M21 21v-5.25m0 0A2.25 2.25 0 0 0 18.75 13.5H4.5M9 3v1.5A1.5 1.5 0 0 0 10.5 6h3A1.5 1.5 0 0 0 15 4.5V3m0 18v-1.5a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 21 19.5V21" />
                    </svg>
                    Performances plateformes
                </h2>
                <div class="insights-grid" id="platformInsights"></div>
            </div>
            <div class="card" id="inventoryCard">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                    </svg>
                    Inventaire
                </h2>
                <button type="button" class="mobile-filters-toggle" id="toggleFilters" aria-controls="filtersPanel" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                    </svg>
                    Filtres & actions
                </button>
                <div class="quick-filters" id="quickFilters">
                    <button type="button" class="quick-filter-btn" data-status-filter="all" aria-pressed="false">Tout</button>
                    <button type="button" class="quick-filter-btn" data-status-filter="en-stock" aria-pressed="false">En stock</button>
                    <button type="button" class="quick-filter-btn" data-status-filter="vendu" aria-pressed="false">Vendus</button>
                </div>
                <div class="filters" id="filtersPanel">
                    <input type="search" id="searchInput" placeholder="Rechercher...">
                    <select id="filterCasier"><option value="all">Tous les casiers</option></select>
                    <select id="filterStatus"><option value="all">Tous les statuts</option></select>
                    <button class="secondary" id="exportCsv">Exporter CSV</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Titre</th>
                                <th>Infos</th>
                                <th>Plateformes</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                    <div class="empty-state" id="emptyState" hidden>
                        <h3>Votre inventaire est vide.</h3>
                        <p>Commencez par ajouter votre premier objet !</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Modal pour gérer les plateformes de vente -->
    <div class="modal platform-modal" id="platformModal" role="dialog" aria-modal="true" aria-labelledby="platformModalTitle">
        <div class="modal-content">
            <button class="close-modal" aria-label="Fermer">✕</button>
            <h3 id="platformModalTitle">Gérer les plateformes de vente</h3>
            <form id="platformForm">
                <input type="hidden" id="platformItemId">
                <input type="hidden" id="platformEditIndex">
                <div class="platform-form">
                    <div class="form-group">
                        <label for="platformSelect">Plateforme</label>
                        <select id="platformSelect" required>
                            <option value="">Sélectionner...</option>
                            <option value="vinted">Vinted</option>
                            <option value="leboncoin">Leboncoin</option>
                            <option value="ebay">eBay</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group full-width" id="customPlatformGroup" style="display: none;">
                        <label for="platformCustomName">Nom de la plateforme</label>
                        <input type="text" id="platformCustomName" placeholder="Nom de la plateforme">
                    </div>
                    <div class="form-group">
                        <label for="platformPrice">Prix de vente (€)</label>
                        <input type="number" id="platformPrice" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="form-group" id="ebayFeesGroup" style="display: none;">
                        <label for="ebayFees">Frais eBay (€)</label>
                        <input type="number" id="ebayFees" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group" id="shippingFeesGroup" style="display: none;">
                        <label for="shippingFees">Frais de livraison (€)</label>
                        <input type="number" id="shippingFees" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="price-suggestion" id="priceSuggestion" hidden>
                        <div><strong id="priceSuggestionValue"></strong> recommandés pour cette plateforme.</div>
                        <div id="priceSuggestionDetails"></div>
                        <button type="button" class="secondary" id="applyPriceSuggestion">Appliquer la suggestion</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="primary">Ajouter</button>
                </div>
            </form>
            <div class="platform-list-modal" id="platformListModal"></div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <nav class="mobile-action-bar" id="mobileActionBar" aria-label="Actions rapides">
        <button type="button" id="mobileScrollInventory">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h18M3 9h18M3 13.5h18M3 18h18" />
            </svg>
            Liste
        </button>
        <button type="button" class="primary-action" id="mobileAddItem">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Ajouter
        </button>
        <button type="button" id="mobileScrollStats">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.071.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Statistiques
        </button>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js" integrity="sha384-tW96d2LkLGjn6+MQnG8drtJjnM/1Urs6IVwy+h81X/yS6Ii+1VOfLntB/rAIum6y" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js" integrity="sha384-l6j4K44jIZE8tm8c7x8uX3fVbw0BQsI2nuAIetsgif9JjTcP6omM6Wanhb7Spbij" crossorigin="anonymous"></script>
    <script>
        // Gestion du mode sombre
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        
        // Vérifier le thème sauvegardé ou les préférences système
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDarkScheme.matches)) {
            document.body.classList.add('dark-mode');
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        // Gestion de l'inventaire
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        normalizeInventory();
        let editMode = false;
        let currentEditId = null;

        // Éléments du DOM
        const itemForm = document.getElementById('itemForm');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const filterCasier = document.getElementById('filterCasier');
        const filterStatus = document.getElementById('filterStatus');
        const filtersPanel = document.getElementById('filtersPanel');
        const toggleFiltersBtn = document.getElementById('toggleFilters');
        const quickFiltersContainer = document.getElementById('quickFilters');
        const quickFilterButtons = quickFiltersContainer ? Array.from(quickFiltersContainer.querySelectorAll('.quick-filter-btn')) : [];
        const exportCsvBtn = document.getElementById('exportCsv');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const aiProcessing = document.getElementById('aiProcessing');
        const notification = document.getElementById('notification');
        const mobileActionBar = document.getElementById('mobileActionBar');
        const mobileAddItemBtn = document.getElementById('mobileAddItem');
        const mobileScrollInventoryBtn = document.getElementById('mobileScrollInventory');
        const mobileScrollStatsBtn = document.getElementById('mobileScrollStats');

        // Éléments pour les statistiques
        const statEnStock = document.getElementById('statEnStock');
        const statVendus = document.getElementById('statVendus');
        const statCA = document.getElementById('statCA');
        const statMarge = document.getElementById('statMarge');
        const platformInsightsCard = document.getElementById('platformInsightsCard');
        const platformInsights = document.getElementById('platformInsights');

        // Éléments pour la gestion des plateformes
        const platformModal = document.getElementById('platformModal');
        const platformForm = document.getElementById('platformForm');
        const platformSelect = document.getElementById('platformSelect');
        const platformPrice = document.getElementById('platformPrice');
        const ebayFees = document.getElementById('ebayFees');
        const ebayFeesGroup = document.getElementById('ebayFeesGroup');
        const shippingFees = document.getElementById('shippingFees');
        const shippingFeesGroup = document.getElementById('shippingFeesGroup');
        const platformListModal = document.getElementById('platformListModal');
        const platformItemId = document.getElementById('platformItemId');
        const platformEditIndex = document.getElementById('platformEditIndex');
        const customPlatformGroup = document.getElementById('customPlatformGroup');
        const platformCustomName = document.getElementById('platformCustomName');
        const platformSubmitBtn = platformForm.querySelector('button[type="submit"]');
        const priceSuggestion = document.getElementById('priceSuggestion');
        const priceSuggestionValue = document.getElementById('priceSuggestionValue');
        const priceSuggestionDetails = document.getElementById('priceSuggestionDetails');
        const applyPriceSuggestionBtn = document.getElementById('applyPriceSuggestion');
        const prixAchatInput = document.getElementById('prixAchat');

        const KNOWN_PLATFORMS = ['vinted', 'leboncoin', 'ebay'];
        const PLATFORM_RULES = {
            vinted: { targetMargin: 0.35, feePercent: 0.08, feeFixed: 0.7, shipping: 0 },
            leboncoin: { targetMargin: 0.3, feePercent: 0.05, feeFixed: 0 },
            ebay: { targetMargin: 0.4, feePercent: 0.12, feeFixed: 0.35, shipping: 4.9 },
            autre: { targetMargin: 0.3, feePercent: 0.05, feeFixed: 0 },
        };

        function safeNumber(value, fallback = 0) {
            const parsed = Number.parseFloat(value);
            return Number.isFinite(parsed) ? parsed : fallback;
        }

        function formatCurrency(value) {
            const number = safeNumber(value);
            return `${number.toFixed(2)} €`;
        }

        function getPlatformRule(type) {
            return PLATFORM_RULES[type] || PLATFORM_RULES.autre;
        }

        function calculateSuggestedPrice(purchasePrice, platformType) {
            const base = safeNumber(purchasePrice);
            if (!base) {
                return null;
            }

            const rule = getPlatformRule(platformType);
            if (!rule) {
                return null;
            }

            const feePercent = safeNumber(rule.feePercent);
            const feeFixed = safeNumber(rule.feeFixed);
            const targetMargin = safeNumber(rule.targetMargin);
            const shipping = safeNumber(rule.shipping);

            const desiredNet = base * (1 + targetMargin) + feeFixed + shipping;
            const salePrice = feePercent >= 0.95 ? desiredNet : desiredNet / (1 - feePercent);
            const platformFees = salePrice * feePercent + feeFixed;
            const estimatedMargin = salePrice - platformFees - shipping - base;

            return {
                price: salePrice,
                margin: estimatedMargin,
                platformFees,
                shipping,
            };
        }

        function updatePriceSuggestion() {
            if (!priceSuggestion) return;

            const selectedType = platformSelect.value || 'autre';
            const purchasePrice = prixAchatInput ? safeNumber(prixAchatInput.value) : 0;
            const suggestion = calculateSuggestedPrice(purchasePrice, selectedType);

            if (!suggestion) {
                priceSuggestion.hidden = true;
                return;
            }

            priceSuggestion.hidden = false;
            priceSuggestionValue.textContent = formatCurrency(suggestion.price);

            const details = [];
            if (suggestion.margin) {
                details.push(`Marge estimée : ${formatCurrency(suggestion.margin)}`);
            }
            if (suggestion.platformFees) {
                details.push(`Frais estimés : ${formatCurrency(suggestion.platformFees)}`);
            }
            if (suggestion.shipping) {
                details.push(`Livraison suggérée : ${formatCurrency(suggestion.shipping)}`);
            }

            priceSuggestionDetails.textContent = details.join(' • ') || '';
        }

        function generatePlatformId() {
            return `plt-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
        }

        function getPlatformLabel(type) {
            switch (type) {
                case 'vinted':
                    return 'Vinted';
                case 'leboncoin':
                    return 'Leboncoin';
                case 'ebay':
                    return 'eBay';
                default:
                    return 'Autre';
            }
        }

        function normalizePlatform(platform) {
            if (!platform) return null;

            if (!platform.id) {
                platform.id = generatePlatformId();
            }

            if (!platform.type) {
                const rawName = (platform.nom || '').toString().toLowerCase();
                if (KNOWN_PLATFORMS.includes(rawName)) {
                    platform.type = rawName;
                    platform.nom = getPlatformLabel(rawName);
                } else {
                    platform.type = platform.type || 'autre';
                    platform.nom = platform.nom || 'Autre';
                }
            } else if (platform.type !== 'autre') {
                platform.nom = getPlatformLabel(platform.type);
            } else {
                platform.nom = platform.nom || 'Autre';
            }

            platform.prix = safeNumber(platform.prix);
            platform.frais = safeNumber(platform.frais);
            platform.livraison = safeNumber(platform.livraison);

            return platform;
        }

        function normalizeItem(item) {
            if (!item) return item;
            item.prixAchat = safeNumber(item.prixAchat);
            item.plateformes = (item.plateformes || []).map(platform => normalizePlatform(platform)).filter(Boolean);

            if (item.vente) {
                item.vente.prix = safeNumber(item.vente.prix);
                item.vente.frais = safeNumber(item.vente.frais);
                item.vente.livraison = safeNumber(item.vente.livraison);
                if (!item.vente.platformId && item.vente.id) {
                    item.vente.platformId = item.vente.id;
                }
            }

            return item;
        }

        function normalizeInventory() {
            inventory = inventory.map(item => normalizeItem(item));
        }

        function isPlatformSold(item, platform) {
            if (!item || !platform) return false;
            if (item.vente && item.vente.platformId) {
                return item.vente.platformId === platform.id;
            }
            if (item.vente) {
                return item.vente.type === platform.type && Math.abs(safeNumber(item.vente.prix) - safeNumber(platform.prix)) < 0.01;
            }
            return false;
        }

        function getPlatformClass(platform) {
            const base = platform?.type || platform?.nom || 'autre';
            return base.toString().toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) return '';
            return value.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeCsvValue(value) {
            const stringValue = value === undefined || value === null ? '' : value.toString();
            return `"${stringValue.replace(/"/g, '""')}"`;
        }

        function getSaleInfo(item) {
            if (!item) return null;

            if (item.vente) {
                return {
                    prix: safeNumber(item.vente.prix),
                    frais: safeNumber(item.vente.frais),
                    livraison: safeNumber(item.vente.livraison),
                    nom: item.vente.nom || getPlatformLabel(item.vente.type),
                    type: item.vente.type || 'autre',
                };
            }

            if (item.statut === 'vendu' && item.plateformes && item.plateformes.length > 0) {
                const bestPlatform = item.plateformes.reduce((best, platform) => {
                    normalizePlatform(platform);
                    if (!best || platform.prix > best.prix) {
                        return platform;
                    }
                    return best;
                }, null);

                if (bestPlatform) {
                    return {
                        prix: safeNumber(bestPlatform.prix),
                        frais: safeNumber(bestPlatform.frais),
                        livraison: safeNumber(bestPlatform.livraison),
                        nom: bestPlatform.nom,
                        type: bestPlatform.type,
                    };
                }
            }

            return null;
        }

        function resetPlatformForm() {
            platformForm.reset();
            platformEditIndex.value = '';
            updatePlatformFieldsVisibility();
            platformSubmitBtn.textContent = 'Ajouter';
        }

        function updatePlatformFieldsVisibility() {
            const selectedType = platformSelect.value;
            const isEbay = selectedType === 'ebay';
            const isCustom = selectedType === 'autre';

            ebayFeesGroup.style.display = isEbay ? 'block' : 'none';
            shippingFeesGroup.style.display = isEbay ? 'block' : 'none';
            customPlatformGroup.style.display = isCustom ? 'block' : 'none';

            if (!isCustom) {
                platformCustomName.value = '';
            }

            updatePriceSuggestion();
        }

        function populatePlatformForm(platform, index) {
            if (!platform) return;
            normalizePlatform(platform);

            platformSelect.value = platform.type;
            updatePlatformFieldsVisibility();
            platformPrice.value = platform.prix;
            ebayFees.value = platform.frais || '';
            shippingFees.value = platform.livraison || '';

            if (platform.type === 'autre') {
                platformCustomName.value = platform.nom;
            }

            platformEditIndex.value = index;
            platformSubmitBtn.textContent = 'Mettre à jour';

            updatePriceSuggestion();
        }

        function markPlatformAsSold(itemId, platformIndex) {
            const item = inventory.find(entry => entry.id === itemId);
            if (!item || !item.plateformes) return;

            const platform = item.plateformes[platformIndex];
            if (!platform) return;

            normalizePlatform(platform);

            if (item.statut === 'vendu' && item.vente && item.vente.platformId !== platform.id) {
                const confirmReplace = confirm(`Une vente est déjà enregistrée sur ${item.vente.nom}. Voulez-vous la remplacer ?`);
                if (!confirmReplace) {
                    return;
                }
            }

            item.statut = 'vendu';
            item.vente = {
                platformId: platform.id,
                type: platform.type,
                nom: platform.nom,
                prix: platform.prix,
                frais: platform.frais || 0,
                livraison: platform.livraison || 0,
                date: new Date().toISOString(),
            };

            saveInventory();
            updatePlatformListModal(item);
            updateInventoryTable();
            updateStats();
            resetPlatformForm();
            platformItemId.value = itemId;

            showNotification(`Vente enregistrée sur ${platform.nom} !`, 'success');
        }

        function cancelSale(itemId, options = {}) {
            const item = inventory.find(entry => entry.id === itemId);
            if (!item) return;

            if (item.vente) {
                delete item.vente;
            }
            item.statut = 'en-stock';

            saveInventory();
            updatePlatformListModal(item);
            updateInventoryTable();
            updateStats();
            resetPlatformForm();
            platformItemId.value = itemId;

            if (!options.silent) {
                showNotification('La vente a été annulée.', 'success');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Définir la date d'aujourd'hui par défaut
            document.getElementById('dateAchat').valueAsDate = new Date();
            
            // Charger l'inventaire
            updateInventoryTable();
            updateStats();
            updateFilters();

            // Gestionnaire d'événements pour le formulaire
            itemForm.addEventListener('submit', handleFormSubmit);

            // Gestionnaire d'événements pour la recherche
            searchInput.addEventListener('input', updateInventoryTable);

            // Gestionnaire d'événements pour les filtres
            filterCasier.addEventListener('change', updateInventoryTable);
            filterStatus.addEventListener('change', updateInventoryTable);

            if (toggleFiltersBtn && filtersPanel) {
                const mobileBreakpoint = window.matchMedia('(max-width: 768px)');

                const syncFiltersVisibility = () => {
                    if (mobileBreakpoint.matches) {
                        filtersPanel.classList.add('collapsed');
                        filtersPanel.classList.remove('open');
                        toggleFiltersBtn.setAttribute('aria-expanded', 'false');
                    } else {
                        filtersPanel.classList.remove('collapsed');
                        filtersPanel.classList.remove('open');
                        toggleFiltersBtn.setAttribute('aria-expanded', 'true');
                    }
                };

                toggleFiltersBtn.addEventListener('click', () => {
                    const willOpen = !filtersPanel.classList.contains('open');
                    filtersPanel.classList.toggle('open', willOpen);
                    filtersPanel.classList.toggle('collapsed', !willOpen);
                    toggleFiltersBtn.setAttribute('aria-expanded', String(willOpen));
                });

                if (typeof mobileBreakpoint.addEventListener === 'function') {
                    mobileBreakpoint.addEventListener('change', syncFiltersVisibility);
                } else if (typeof mobileBreakpoint.addListener === 'function') {
                    mobileBreakpoint.addListener(syncFiltersVisibility);
                }
                syncFiltersVisibility();
            }

            if (quickFilterButtons && quickFilterButtons.length) {
                quickFilterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const status = button.dataset.statusFilter;
                        filterStatus.value = status;
                        updateInventoryTable();
                    });
                });
            }

            // Gestionnaire d'événements pour l'export CSV
            exportCsvBtn.addEventListener('click', exportToCsv);

            // Gestionnaire d'événements pour l'annulation de l'édition
            cancelEditBtn.addEventListener('click', cancelEdit);

            // Gestionnaire d'événements pour la photo
            photoInput.addEventListener('change', handlePhotoUpload);

            if (prixAchatInput) {
                prixAchatInput.addEventListener('input', updatePriceSuggestion);
            }

            if (applyPriceSuggestionBtn) {
                applyPriceSuggestionBtn.addEventListener('click', () => {
                    const suggestion = calculateSuggestedPrice(prixAchatInput ? prixAchatInput.value : 0, platformSelect.value || 'autre');
                    if (!suggestion) {
                        return;
                    }

                    platformPrice.value = suggestion.price.toFixed(2);

                    if (platformSelect.value === 'ebay') {
                        ebayFees.value = suggestion.platformFees.toFixed(2);
                        if (!shippingFees.value && suggestion.shipping) {
                            shippingFees.value = suggestion.shipping.toFixed(2);
                        }
                    }
                });
            }

            // Gestionnaire d'événements pour le formulaire des plateformes
            platformForm.addEventListener('submit', handlePlatformSubmit);

            // Gestionnaire d'événements pour le changement de plateforme
            platformSelect.addEventListener('change', updatePlatformFieldsVisibility);
            updatePlatformFieldsVisibility();

            if (mobileAddItemBtn) {
                mobileAddItemBtn.addEventListener('click', () => {
                    itemForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => {
                        document.getElementById('titre')?.focus();
                    }, 300);
                });
            }

            if (mobileScrollInventoryBtn) {
                mobileScrollInventoryBtn.addEventListener('click', () => {
                    document.getElementById('inventoryCard')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            if (mobileScrollStatsBtn) {
                mobileScrollStatsBtn.addEventListener('click', () => {
                    document.getElementById('statsCard')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            // Gestionnaire d'événements pour fermer les modales
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    resetPlatformForm();
                    platformModal.classList.remove('visible');
                });
            });

            // Fermer les modales en cliquant à l'extérieur
            window.addEventListener('click', (e) => {
                if (e.target === platformModal) {
                    resetPlatformForm();
                    platformModal.classList.remove('visible');
                }
            });
        });

        // Gestion de la soumission du formulaire
        function handleFormSubmit(e) {
            e.preventDefault();

            const existingItem = editMode ? inventory.find(item => item.id === currentEditId) : null;
            const itemData = {
                id: existingItem ? existingItem.id : Date.now().toString(),
                titre: document.getElementById('titre').value.trim(),
                casier: document.getElementById('casier').value.trim(),
                prixAchat: safeNumber(document.getElementById('prixAchat').value),
                dateAchat: document.getElementById('dateAchat').value,
                notes: document.getElementById('notes').value.trim(),
                photo: photoPreview.src || '',
                statut: existingItem ? existingItem.statut : 'en-stock',
                plateformes: existingItem ? existingItem.plateformes : [],
                vente: existingItem && existingItem.vente ? existingItem.vente : null,
            };

            normalizeItem(itemData);

            if (editMode) {
                // Mettre à jour l'élément existant
                const index = inventory.findIndex(item => item.id === currentEditId);
                if (index !== -1) {
                    inventory[index] = { ...inventory[index], ...itemData };
                }
                showNotification('Objet modifié avec succès!', 'success');
            } else {
                // Ajouter un nouvel élément
                inventory.push(itemData);
                showNotification('Objet ajouté à l\'inventaire!', 'success');
            }

            // Sauvegarder et mettre à jour l'interface
            saveInventory();
            resetForm();
            updateInventoryTable();
            updateStats();
            updateFilters();
        }

        // Gestion de l'upload de photo
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    photoPreview.src = event.target.result;
                    photoPreviewContainer.style.display = 'block';

                    if (photoPreview.complete) {
                        analyzePhotoWithAI();
                    } else {
                        photoPreview.onload = () => {
                            analyzePhotoWithAI();
                            photoPreview.onload = null;
                        };
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        let aiModelPromise = null;

        async function loadAiModel() {
            if (!aiModelPromise) {
                aiModelPromise = mobilenet.load();
            }
            return aiModelPromise;
        }

        function formatPredictionLabel(label) {
            if (!label) return '';
            return label
                .split(',')[0]
                .split(/\s+/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        async function analyzePhotoWithAI() {
            if (!photoPreview.src) return;

            aiProcessing.classList.remove('hidden');

            try {
                const model = await loadAiModel();
                await tf.nextFrame();
                const predictions = await model.classify(photoPreview, 1);

                if (predictions && predictions.length > 0) {
                    const bestPrediction = predictions[0];
                    const formattedLabel = formatPredictionLabel(bestPrediction.className);
                    if (formattedLabel) {
                        document.getElementById('titre').value = formattedLabel;
                    }
                }
            } catch (error) {
                console.error('Analyse IA impossible :', error);
                showNotification("Impossible d'analyser la photo. Merci de saisir le titre manuellement.", 'warning');
            } finally {
                aiProcessing.classList.add('hidden');
            }
        }

        // Mettre à jour le tableau d'inventaire
        function updateInventoryTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const casierFilter = filterCasier.value;
            const statusFilter = filterStatus.value;
            
            // Filtrer l'inventaire
            let filteredInventory = inventory.filter(item => {
                const matchesSearch = item.titre.toLowerCase().includes(searchTerm) || 
                                     item.casier.toLowerCase().includes(searchTerm) ||
                                     (item.notes && item.notes.toLowerCase().includes(searchTerm));
                const matchesCasier = casierFilter === 'all' || item.casier === casierFilter;
                const matchesStatus = statusFilter === 'all' || item.statut === statusFilter;
                
                return matchesSearch && matchesCasier && matchesStatus;
            });
            
            // Afficher/masquer l'état vide
            if (filteredInventory.length === 0) {
                emptyState.hidden = false;
                inventoryTableBody.innerHTML = '';
            } else {
                emptyState.hidden = true;
                
                // Générer les lignes du tableau
                inventoryTableBody.innerHTML = filteredInventory.map(item => {
                    const isSold = item.statut === 'vendu';
                    const statusClass = isSold ? 'sold' : 'on-sale';
                    const photoHtml = item.photo
                        ? `<img src="${item.photo}" alt="${escapeHtml(item.titre)}" class="thumbnail">`
                        : '—';
                    const notesHtml = item.notes
                        ? `<div style="margin-top: 0.25rem;"><strong>Notes:</strong> ${escapeHtml(item.notes)}</div>`
                        : '';

                    const platformTags = item.plateformes && item.plateformes.length > 0
                        ? item.plateformes.map(platform => {
                            normalizePlatform(platform);
                            const platformClass = getPlatformClass(platform);
                            const soldClass = isPlatformSold(item, platform) ? ' sold' : '';
                            const feesParts = [];
                            if (platform.frais) {
                                feesParts.push(`Frais: ${formatCurrency(platform.frais)}`);
                            }
                            if (platform.livraison) {
                                feesParts.push(`Livraison: ${formatCurrency(platform.livraison)}`);
                            }
                            const feesHtml = feesParts.length ? `<div class="platform-fees">${feesParts.join(' • ')}</div>` : '';
                            return `
                            <div class="platform-tag ${platformClass}${soldClass}">
                                ${escapeHtml(platform.nom)}
                                <span class="platform-price">${formatCurrency(platform.prix)}</span>
                                ${feesHtml}
                            </div>
                        `;
                        }).join('')
                        : '<div class="platform-tag autre">Aucune</div>';

                    const saleInfo = getSaleInfo(item);
                    const totalSaleFees = saleInfo ? safeNumber(saleInfo.frais) + safeNumber(saleInfo.livraison) : 0;
                    const marginValue = saleInfo ? safeNumber(saleInfo.prix) - totalSaleFees - safeNumber(item.prixAchat) : 0;
                    const saleDetails = saleInfo ? `
                        <div class="sale-details">
                            Vendu sur ${escapeHtml(saleInfo.nom)} • ${formatCurrency(saleInfo.prix)}
                            ${totalSaleFees ? ` • Frais: ${formatCurrency(totalSaleFees)}` : ''}
                            • Marge: ${formatCurrency(marginValue)}
                        </div>
                    ` : '';
                    const statusLabel = isSold
                        ? `✓ Vendu${saleInfo ? ` (${escapeHtml(saleInfo.nom)})` : ''}`
                        : '↻ En vente';

                    return `
                        <tr>
                            <td data-label="Photo">
                                ${photoHtml}
                            </td>
                            <td data-label="Titre">
                                <strong>${escapeHtml(item.titre)}</strong>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Acheté: ${formatDate(item.dateAchat)} | ${formatCurrency(item.prixAchat)}
                                </div>
                            </td>
                            <td data-label="Infos">
                                <div><strong>Casier:</strong> ${escapeHtml(item.casier)}</div>
                                ${notesHtml}
                            </td>
                            <td data-label="Plateformes">
                                <div class="platform-list">
                                    ${platformTags}
                                </div>
                            </td>
                            <td data-label="Statut">
                                <span class="status ${statusClass}">
                                    ${statusLabel}
                                </span>
                                ${saleDetails}
                            </td>
                            <td class="actions-cell" data-label="Actions">
                                <button class="platform-btn" title="Gérer les plateformes" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z" />
                                    </svg>
                                </button>
                                <button class="edit-btn" title="Modifier" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                    </svg>
                                </button>
                                <button class="delete-btn" title="Supprimer" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Ajouter les gestionnaires d'événements pour les boutons
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editItem(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        deleteItem(id);
                    });
                });
                
                document.querySelectorAll('.platform-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        openPlatformModal(id);
                    });
                });
            }

            updateQuickFilterState();
        }

        // Ouvrir la modale de gestion des plateformes
        function openPlatformModal(itemId) {
            const item = inventory.find(item => item.id === itemId);
            if (!item) return;

            resetPlatformForm();
            platformItemId.value = itemId;

            // Afficher les plateformes existantes
            updatePlatformListModal(item);

            platformModal.classList.add('visible');
            setTimeout(() => {
                platformSelect.focus();
            }, 0);
        }

        // Mettre à jour la liste des plateformes dans la modale
        function updatePlatformListModal(item) {
            if (!item.plateformes || item.plateformes.length === 0) {
                platformListModal.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucune plateforme ajoutée</p>';
                return;
            }

            platformListModal.innerHTML = item.plateformes.map((platform, index) => {
                normalizePlatform(platform);
                const isSold = isPlatformSold(item, platform);
                const detailParts = [`Prix: ${formatCurrency(platform.prix)}`];

                if (platform.frais) {
                    detailParts.push(`Frais: ${formatCurrency(platform.frais)}`);
                }
                if (platform.livraison) {
                    detailParts.push(`Livraison: ${formatCurrency(platform.livraison)}`);
                }

                const saleStatus = isSold
                    ? `<div class="platform-item-status">Vente enregistrée${item.vente?.date ? ` le ${new Date(item.vente.date).toLocaleDateString('fr-FR')}` : ''}</div>`
                    : '';

                const actionButtons = `
                    <div class="platform-item-actions">
                        <button class="secondary edit-platform" data-index="${index}">Modifier</button>
                        <button class="secondary remove-platform" data-index="${index}">Supprimer</button>
                        ${isSold
                            ? `<button class="secondary cancel-sale" data-index="${index}">Annuler la vente</button>`
                            : `<button class="primary mark-sold" data-index="${index}">Marquer vendu</button>`}
                    </div>
                `;

                return `
                    <div class="platform-item">
                        <div class="platform-item-info">
                            <div class="platform-item-name">
                                ${escapeHtml(platform.nom)}
                            </div>
                            ${saleStatus}
                            <div class="platform-item-details">
                                ${detailParts.join(' | ')}
                            </div>
                        </div>
                        ${actionButtons}
                    </div>
                `;
            }).join('');

            const modalItemId = platformItemId.value;

            platformListModal.querySelectorAll('.remove-platform').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    removePlatform(modalItemId, index);
                });
            });

            platformListModal.querySelectorAll('.edit-platform').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    const currentItem = inventory.find(entry => entry.id === modalItemId);
                    if (!currentItem) return;
                    const platform = currentItem.plateformes[index];
                    if (!platform) return;
                    populatePlatformForm(platform, index);
                });
            });

            platformListModal.querySelectorAll('.mark-sold').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    markPlatformAsSold(modalItemId, index);
                });
            });

            platformListModal.querySelectorAll('.cancel-sale').forEach(button => {
                button.addEventListener('click', (e) => {
                    const currentItem = inventory.find(entry => entry.id === modalItemId);
                    if (!currentItem) return;
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    const platform = currentItem.plateformes[index];
                    if (!platform) return;
                    cancelSale(modalItemId);
                });
            });
        }

        // Supprimer une plateforme
        function removePlatform(itemId, platformIndex) {
            const item = inventory.find(item => item.id === itemId);
            if (!item || !item.plateformes) return;

            const platform = item.plateformes[platformIndex];
            if (!platform) return;

            normalizePlatform(platform);
            const wasSalePlatform = isPlatformSold(item, platform);

            item.plateformes.splice(platformIndex, 1);

            let message = 'Plateforme supprimée.';
            if (wasSalePlatform) {
                if (item.vente) {
                    delete item.vente;
                }
                item.statut = 'en-stock';
                message = 'Plateforme supprimée et vente annulée.';
            }

            saveInventory();
            updatePlatformListModal(item);
            updateInventoryTable();
            updateStats();
            resetPlatformForm();
            platformItemId.value = itemId;
            showNotification(message, 'success');
        }

        // Gérer la soumission du formulaire de plateforme
        function handlePlatformSubmit(e) {
            e.preventDefault();

            const itemId = platformItemId.value;
            const item = inventory.find(item => item.id === itemId);
            if (!item) {
                showNotification('Aucun objet sélectionné.', 'error');
                return;
            }

            const selectedType = platformSelect.value;
            if (!selectedType) {
                showNotification('Veuillez sélectionner une plateforme.', 'error');
                return;
            }

            const priceValue = Number.parseFloat(platformPrice.value);
            if (!Number.isFinite(priceValue)) {
                showNotification('Veuillez indiquer un prix de vente valide.', 'error');
                platformPrice.focus();
                return;
            }

            if (priceValue < 0) {
                showNotification('Le prix de vente doit être positif.', 'error');
                platformPrice.focus();
                return;
            }

            const platformData = {
                type: selectedType,
                nom: selectedType === 'autre' ? platformCustomName.value.trim() : getPlatformLabel(selectedType),
                prix: Math.max(0, safeNumber(priceValue)),
                frais: 0,
                livraison: 0,
            };

            if (selectedType === 'autre' && !platformData.nom) {
                showNotification('Veuillez indiquer le nom de la plateforme.', 'error');
                platformCustomName.focus();
                return;
            }

            if (selectedType === 'ebay') {
                platformData.frais = Math.max(0, safeNumber(ebayFees.value));
                platformData.livraison = Math.max(0, safeNumber(shippingFees.value));
            }

            if (!item.plateformes) {
                item.plateformes = [];
            }

            const editIndexValue = platformEditIndex.value;
            let message = 'Plateforme ajoutée avec succès!';

            if (editIndexValue !== '') {
                const index = parseInt(editIndexValue, 10);
                const existingPlatform = item.plateformes[index];
                const platformId = existingPlatform?.id || generatePlatformId();
                item.plateformes[index] = { ...existingPlatform, ...platformData, id: platformId };
                normalizePlatform(item.plateformes[index]);

                if (item.vente && item.vente.platformId === platformId) {
                    item.vente = { ...item.vente, ...platformData, platformId };
                }

                message = 'Plateforme mise à jour avec succès!';
            } else {
                platformData.id = generatePlatformId();
                item.plateformes.push(platformData);
                normalizePlatform(item.plateformes[item.plateformes.length - 1]);
            }

            saveInventory();
            updatePlatformListModal(item);
            updateInventoryTable();
            updateStats();

            resetPlatformForm();
            platformItemId.value = itemId;

            showNotification(message, 'success');
        }

        // Modifier un élément
        function editItem(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) return;
            
            // Remplir le formulaire avec les données de l'élément
            document.getElementById('editItemId').value = item.id;
            document.getElementById('titre').value = item.titre;
            document.getElementById('casier').value = item.casier;
            document.getElementById('prixAchat').value = item.prixAchat;
            document.getElementById('dateAchat').value = item.dateAchat;
            document.getElementById('notes').value = item.notes || '';
            
            if (item.photo) {
                photoPreview.src = item.photo;
                photoPreviewContainer.style.display = 'block';
            } else {
                photoPreviewContainer.style.display = 'none';
            }
            
            // Passer en mode édition
            editMode = true;
            currentEditId = id;
            formTitle.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                </svg>
                Modifier l'objet
            `;
            submitBtn.textContent = 'Mettre à jour';
            cancelEditBtn.hidden = false;
            
            // Faire défler vers le formulaire
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Annuler l'édition
        function cancelEdit() {
            resetForm();
        }

        // Supprimer un élément
        function deleteItem(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet objet ?')) {
                inventory = inventory.filter(item => item.id !== id);
                saveInventory();
                updateInventoryTable();
                updateStats();
                updateFilters();
                showNotification('Objet supprimé avec succès!', 'success');
            }
        }

        // Réinitialiser le formulaire
        function resetForm() {
            itemForm.reset();
            document.getElementById('dateAchat').valueAsDate = new Date();
            photoPreviewContainer.style.display = 'none';
            editMode = false;
            currentEditId = null;
            formTitle.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Ajouter un objet
            `;
            submitBtn.textContent = 'Ajouter à l\'inventaire';
            cancelEditBtn.hidden = true;
        }

        // Mettre à jour les statistiques
        function updateStats() {
            const enStock = inventory.filter(item => item.statut === 'en-stock').length;
            const vendus = inventory.filter(item => item.statut === 'vendu').length;

            // Calculer le chiffre d'affaires et la marge
            let ca = 0;
            let marge = 0;

            inventory.forEach(item => {
                if (item.statut === 'vendu') {
                    const saleInfo = getSaleInfo(item);
                    if (saleInfo) {
                        const salePrice = safeNumber(saleInfo.prix);
                        const totalFees = safeNumber(saleInfo.frais) + safeNumber(saleInfo.livraison);
                        ca += salePrice;
                        marge += salePrice - totalFees - safeNumber(item.prixAchat);
                    }
                }
            });

            statEnStock.textContent = enStock;
            statVendus.textContent = vendus;
            statCA.textContent = formatCurrency(ca);
            statMarge.textContent = formatCurrency(marge);

            updatePlatformInsights();
        }

        function updatePlatformInsights() {
            if (!platformInsights || !platformInsightsCard) {
                return;
            }

            const summary = {};

            inventory.forEach(item => {
                if (!item.plateformes || item.plateformes.length === 0) {
                    return;
                }

                item.plateformes.forEach(platform => {
                    normalizePlatform(platform);
                    const key = platform.type === 'autre' ? (platform.nom || 'autre') : (platform.type || 'autre');

                    if (!summary[key]) {
                        summary[key] = {
                            nom: platform.type === 'autre' ? (platform.nom || 'Autre') : getPlatformLabel(platform.type),
                            listed: 0,
                            ventes: 0,
                            chiffreAffaires: 0,
                            marge: 0,
                        };
                    }

                    summary[key].listed += 1;

                    if (isPlatformSold(item, platform)) {
                        summary[key].ventes += 1;
                        const saleInfo = getSaleInfo(item);
                        if (saleInfo) {
                            const salePrice = safeNumber(saleInfo.prix);
                            const totalFees = safeNumber(saleInfo.frais) + safeNumber(saleInfo.livraison);
                            summary[key].chiffreAffaires += salePrice;
                            summary[key].marge += salePrice - totalFees - safeNumber(item.prixAchat);
                        }
                    }
                });
            });

            const entries = Object.values(summary).sort((a, b) => b.chiffreAffaires - a.chiffreAffaires);

            if (entries.length === 0) {
                platformInsights.innerHTML = '<p style="color: var(--text-muted);">Ajoutez des plateformes pour suivre leurs performances.</p>';
                platformInsightsCard.hidden = false;
                return;
            }

            platformInsightsCard.hidden = false;
            platformInsights.innerHTML = entries.map(entry => {
                const listedLabel = `${entry.listed} annonce${entry.listed > 1 ? 's' : ''}`;
                const salesLabel = `${entry.ventes} vente${entry.ventes > 1 ? 's' : ''}`;
                return `
                    <div class="insight-card">
                        <span class="insight-title">${escapeHtml(entry.nom)}</span>
                        <span class="insight-value">${formatCurrency(entry.chiffreAffaires)}</span>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">${listedLabel} • ${salesLabel}</span>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">Marge : ${formatCurrency(entry.marge)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateQuickFilterState() {
            if (!quickFilterButtons || quickFilterButtons.length === 0) {
                return;
            }

            const current = filterStatus.value || 'all';
            quickFilterButtons.forEach(button => {
                const isActive = button.dataset.statusFilter === current;
                button.classList.toggle('active', isActive);
                button.setAttribute('aria-pressed', String(isActive));
            });
        }

        // Mettre à jour les filtres
        function updateFilters() {
            const previousCasier = filterCasier.value;
            const previousStatus = filterStatus.value;

            // Mettre à jour le filtre des casiers
            const casiers = [...new Set(inventory.map(item => item.casier).filter(Boolean))].sort();
            filterCasier.innerHTML = '<option value="all">Tous les casiers</option>' +
                casiers.map(casier => {
                    const safeValue = escapeHtml(casier);
                    return `<option value="${safeValue}">${safeValue}</option>`;
                }).join('');

            if (filterCasier.querySelector(`option[value="${previousCasier}"]`)) {
                filterCasier.value = previousCasier;
            }

            // Mettre à jour le filtre des statuts
            filterStatus.innerHTML = `
                <option value="all">Tous les statuts</option>
                <option value="en-stock">En stock</option>
                <option value="vendu">Vendu</option>
            `;

            if (filterStatus.querySelector(`option[value="${previousStatus}"]`)) {
                filterStatus.value = previousStatus;
            }

            updateQuickFilterState();
        }

        // Exporter en CSV
        function exportToCsv() {
            if (inventory.length === 0) {
                showNotification('Aucune donnée à exporter!', 'error');
                return;
            }
            
            const headers = [
                'Titre',
                'Casier',
                'Prix d\'achat',
                'Date d\'achat',
                'Notes',
                'Statut',
                'Plateformes',
                'Plateforme vente',
                'Prix vente',
                'Frais vente',
                'Marge',
            ];
            const csvContent = [
                headers.join(','),
                ...inventory.map(item => {
                    const platforms = item.plateformes && item.plateformes.length > 0
                        ? item.plateformes.map(platform => {
                            normalizePlatform(platform);
                            const parts = [`${platform.nom}:${safeNumber(platform.prix).toFixed(2)}€`];
                            const extras = [];
                            if (platform.frais) {
                                extras.push(`Frais:${safeNumber(platform.frais).toFixed(2)}€`);
                            }
                            if (platform.livraison) {
                                extras.push(`Livraison:${safeNumber(platform.livraison).toFixed(2)}€`);
                            }
                            if (extras.length) {
                                parts.push(`(${extras.join(' | ')})`);
                            }
                            return parts.join(' ');
                        }).join('; ')
                        : 'Aucune';

                    const saleInfo = getSaleInfo(item);
                    const totalFees = saleInfo ? safeNumber(saleInfo.frais) + safeNumber(saleInfo.livraison) : 0;
                    const marginValue = saleInfo ? safeNumber(saleInfo.prix) - totalFees - safeNumber(item.prixAchat) : 0;

                    return [
                        escapeCsvValue(item.titre),
                        escapeCsvValue(item.casier),
                        safeNumber(item.prixAchat).toFixed(2),
                        escapeCsvValue(item.dateAchat),
                        escapeCsvValue(item.notes || ''),
                        escapeCsvValue(item.statut === 'en-stock' ? 'En stock' : 'Vendu'),
                        escapeCsvValue(platforms),
                        escapeCsvValue(saleInfo ? saleInfo.nom : ''),
                        saleInfo ? safeNumber(saleInfo.prix).toFixed(2) : '',
                        saleInfo ? totalFees.toFixed(2) : '',
                        saleInfo ? marginValue.toFixed(2) : '',
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `inventaire_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Export CSV réussi!', 'success');
        }

        // Sauvegarder l'inventaire
        function saveInventory() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        // Formater une date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Afficher une notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type, 'show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>