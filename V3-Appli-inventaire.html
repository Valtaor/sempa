<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Pro - Gestion Intelligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #f9fafb;
            --surface: #ffffff;
            --primary: #6d28d9;
            --primary-light: #ede9fe;
            --secondary: #10b981;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            background: linear-gradient(120deg, var(--primary), #8b5cf6);
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.2rem, 5vw, 3.2rem);
            margin: 0 0 0.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 400px 1fr;
                align-items: flex-start;
            }
        }

        .card {
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 1.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin: 0 0 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .card-title svg { width: 28px; height: 28px; color: var(--primary); }

        .form-section {
            position: sticky;
            top: 2rem;
        }

        .form-grid { display: grid; gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; }
        
        label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.85rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* Styled File Input */
        .file-upload-wrapper {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%; height: 100%;
            top: 0; left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-text { color: var(--text-secondary); }
        .file-upload-text span { color: var(--primary); font-weight: 600; }
        
        .photo-preview {
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            max-width: 150px;
            display: none;
        }
        .photo-preview img { display: block; width: 100%; }
        
        .form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }

        button {
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button.primary {
            background: linear-gradient(120deg, var(--primary), #8b5cf6);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        button.primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        button.secondary { background-color: #e5e7eb; color: var(--text-primary); }
        button.secondary:hover { background-color: #d1d5db; }
        
        .dashboard-grid { display: grid; gap: 2rem; }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        thead { background-color: var(--background); }
        tbody tr:nth-child(odd) { background-color: var(--surface); }
        tbody tr:nth-child(even) { background-color: var(--background); }
        tbody tr:hover { background-color: var(--primary-light); }

        .thumbnail { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; box-shadow: var(--shadow-sm); }
        
        .status {
            display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px;
            border-radius: 999px; font-size: 0.85rem; font-weight: 600;
        }
        .status.on-sale { background-color: #d1fae5; color: #065f46; }
        .status.sold { background-color: #e5e7eb; color: #4b5563; }

        .actions-cell { display: flex; gap: 0.5rem; }
        .actions-cell button {
            background: none; border: 1px solid var(--border-color); border-radius: 999px;
            width: 36px; height: 36px; padding: 0;
            color: var(--text-secondary);
        }
        .actions-cell button:hover { background-color: var(--background); color: var(--text-primary); }
        .actions-cell button.delete:hover { background-color: var(--danger-light); color: var(--danger); }
        .actions-cell button svg { width: 16px; height: 16px; }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .stat-card {
            background-color: var(--background); border-radius: var(--radius); padding: 1.25rem;
            border: 1px solid transparent;
        }
        .stat-card h3 { margin: 0 0 0.5rem; font-size: 0.9rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; }
        .stat-card svg { width: 16px; height: 16px; }
        .stat-card .value { font-size: 2.2rem; font-weight: 700; color: var(--text-primary); }

        /* Modal Styles */
        .modal {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--surface); padding: 2rem; border-radius: var(--radius);
            width: min(450px, 90vw); box-shadow: var(--shadow-lg); position: relative;
            transform: translateY(20px) scale(0.95); transition: transform 0.3s ease;
        }
        .modal.visible .modal-content { transform: translateY(0) scale(1); }
        .modal-content h3 { margin-top: 0; font-family: 'Playfair Display', serif; }
        .close-modal {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--text-secondary);
        }
        
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <header>
        <h1>Inventaire Pro</h1>
        <p>Votre assistant intelligent pour la gestion de tr√©sors et d'objets de collection.</p>
    </header>

    <main class="container">
        <section class="form-section card">
            <h2 class="card-title" id="formTitle">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                Ajouter un objet
            </h2>
            <form id="itemForm">
                <input type="hidden" id="editItemId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="photo">Photo</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="photo" accept="image/*">
                            <div class="file-upload-text">
                                <p>Glissez-d√©posez une image ou <br><span>cliquez pour parcourir</span></p>
                            </div>
                        </div>
                        <div class="photo-preview" id="photoPreviewContainer">
                            <img id="photoPreview" alt="Pr√©visualisation">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="titre">Titre de l'objet</label>
                        <input type="text" id="titre" placeholder="G√©n√©r√© via la photo..." required>
                    </div>
                    <div class="form-group">
                        <label for="casier">Casier / Emplacement</label>
                        <input type="text" id="casier" placeholder="Ex: A1, Bx1" required>
                    </div>
                    <div class="form-group">
                        <label for="prixAchat">Prix d'achat (‚Ç¨)</label>
                        <input type="number" id="prixAchat" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="dateAchat">Date d'achat</label>
                        <input type="date" id="dateAchat" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (facultatif)</label>
                        <textarea id="notes" rows="3" placeholder="√âtat, provenance..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" id="cancelEditBtn" hidden>Annuler</button>
                    <button type="submit" class="primary" id="submitBtn">Ajouter √† l'inventaire</button>
                </div>
            </form>
        </section>

        <section class="dashboard-grid">
            <div class="card">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>
                    Statistiques
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg> En stock</h3>
                        <div class="value" id="statEnStock">0</div>
                    </div>
                    <div class="stat-card">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg> Vendus</h3>
                        <div class="value" id="statVendus">0</div>
                    </div>
                    <div class="stat-card">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /></svg> C.A.</h3>
                        <div class="value" id="statCA">0 ‚Ç¨</div>
                    </div>
                    <div class="stat-card">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Marge</h3>
                        <div class="value" id="statMarge">0 ‚Ç¨</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                    Inventaire
                </h2>
                <div class="filters">
                    <input type="search" id="searchInput" placeholder="Rechercher...">
                    <select id="filterCasier"><option value="all">Tous les casiers</option></select>
                    <select id="filterStatus"><option value="all">Tous les statuts</option></select>
                    <button class="secondary" id="exportCsv">Exporter CSV</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Titre</th>
                                <th>Infos</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                    <div class="empty-state" id="emptyState" hidden>
                        <h3>Votre inventaire est vide.</h3>
                        <p>Commencez par ajouter votre premier objet !</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div class="modal" id="saleModal" role="dialog" aria-modal="true" aria-labelledby="saleModalTitle">
        <div class="modal-content">
            <button class="close-modal" aria-label="Fermer">‚úï</button>
            <h3 id="saleModalTitle">Renseigner la vente</h3>
            <form id="saleForm">
                <input type="hidden" id="saleItemId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="salePrice">Prix de vente (‚Ç¨)</label>
                        <input type="number" id="salePrice" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="saleDate">Date de vente</label>
                        <input type="date" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label for="salePlatform">Plateforme</label>
                        <select id="salePlatform">
                            <option value="eBay">eBay</option>
                            <option value="Vinted">Vinted</option>
                            <option value="Leboncoin">Leboncoin</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions" style="justify-content: space-between;">
                    <button type="button" class="secondary" id="markAvailableBtn">Remettre en stock</button>
                    <button type="submit" class="primary">Valider la vente</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
    <script>
        const STORAGE_KEY_V2 = 'inventaire_vintage_items_v2';
        let mobilenetModel = null;

        const el = {
            form: document.getElementById('itemForm'),
            formTitle: document.getElementById('formTitle'),
            submitBtn: document.getElementById('submitBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            editItemId: document.getElementById('editItemId'),
            photoInput: document.getElementById('photo'),
            previewContainer: document.getElementById('photoPreviewContainer'),
            previewImage: document.getElementById('photoPreview'),
            titre: document.getElementById('titre'),
            casier: document.getElementById('casier'),
            prixAchat: document.getElementById('prixAchat'),
            dateAchat: document.getElementById('dateAchat'),
            notes: document.getElementById('notes'),
            tableBody: document.getElementById('inventoryTableBody'),
            emptyState: document.getElementById('emptyState'),
            filterCasier: document.getElementById('filterCasier'),
            filterStatus: document.getElementById('filterStatus'),
            searchInput: document.getElementById('searchInput'),
            exportCsv: document.getElementById('exportCsv'),
            saleModal: document.getElementById('saleModal'),
            saleForm: document.getElementById('saleForm'),
            saleItemId: document.getElementById('saleItemId'),
            salePrice: document.getElementById('salePrice'),
            saleDate: document.getElementById('saleDate'),
            salePlatform: document.getElementById('salePlatform'),
            markAvailableBtn: document.getElementById('markAvailableBtn'),
            statEnStock: document.getElementById('statEnStock'),
            statVendus: document.getElementById('statVendus'),
            statCA: document.getElementById('statCA'),
            statMarge: document.getElementById('statMarge'),
        };

        const state = {
            items: [],
            filters: { casier: 'all', status: 'all', search: '' },
            isEditMode: false,
        };

        async function loadMobilenet() {
            try {
                mobilenetModel = await mobilenet.load();
                console.log('MobileNet model loaded.');
            } catch (error) {
                console.warn('Could not load Mobilenet model:', error);
            }
        }

        function loadItems() {
            const stored = localStorage.getItem(STORAGE_KEY_V2);
            state.items = stored ? JSON.parse(stored) : [];
            state.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        function saveItems() {
            localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(state.items));
        }

        function resetForm() {
            el.form.reset();
            el.previewContainer.style.display = 'none';
            el.previewImage.src = '';
            delete el.previewImage.dataset.imageData;
            exitEditMode();
        }

        async function handlePhotoChange(event) {
            const file = event.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const dataUrl = e.target.result;
                el.previewImage.src = dataUrl;
                el.previewContainer.style.display = 'block';
                el.previewImage.dataset.imageData = dataUrl;
                generateTitle(el.previewImage);
            };
            reader.readAsDataURL(file);
        }

        async function generateTitle(imageEl) {
            if (!mobilenetModel) {
                el.titre.placeholder = "Mod√®le IA non charg√©...";
                return;
            }
            
            el.titre.value = "";
            el.titre.placeholder = "Analyse de l'image...";
            el.titre.disabled = true;

            try {
                const results = await mobilenetModel.classify(imageEl);
                if (results?.length) {
                    const topResult = results[0].className.split(',')[0];
                    const suggestion = topResult.charAt(0).toUpperCase() + topResult.slice(1);
                    el.titre.value = suggestion;
                } else {
                    el.titre.placeholder = "Aucun objet d√©tect√©";
                }
            } catch (err) {
                console.warn('Classification failed:', err);
                el.titre.placeholder = "Erreur d'analyse";
            } finally {
                el.titre.disabled = false;
                if (!el.titre.value) el.titre.placeholder = "G√©n√©r√© via la photo...";
            }
        }

        function enterEditMode(itemId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            state.isEditMode = true;
            el.editItemId.value = item.id;
            el.titre.value = item.titre;
            el.casier.value = item.casier;
            el.prixAchat.value = item.prixAchat;
            el.dateAchat.value = item.dateAchat;
            el.notes.value = item.notes;

            if (item.photoData) {
                el.previewImage.src = item.photoData;
                el.previewImage.dataset.imageData = item.photoData;
                el.previewContainer.style.display = 'block';
            } else {
                el.previewContainer.style.display = 'none';
            }

            el.formTitle.lastChild.textContent = " Modifier l'objet";
            el.submitBtn.textContent = 'Sauvegarder';
            el.cancelEditBtn.hidden = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exitEditMode() {
            state.isEditMode = false;
            el.editItemId.value = '';
            el.photoInput.value = '';
            el.formTitle.lastChild.textContent = " Ajouter un objet";
            el.submitBtn.textContent = 'Ajouter √† l\'inventaire';
            el.cancelEditBtn.hidden = true;
        }

        function render() {
            renderFilters();
            renderTable();
            renderStats();
        }
        
        function renderFilters() {
            const casiers = [...new Set(state.items.map(i => i.casier))].sort();
            el.filterCasier.innerHTML = '<option value="all">Tous les casiers</option>' + 
                casiers.map(c => `<option value="${c}">${c}</option>`).join('');
            el.filterCasier.value = state.filters.casier;
        }

        function renderTable() {
            const filteredItems = state.items.filter(item => 
                (state.filters.casier === 'all' || item.casier === state.filters.casier) &&
                (state.filters.status === 'all' || (state.filters.status === 'sold' && item.vendu) || (state.filters.status === 'available' && !item.vendu)) &&
                (!state.filters.search || item.titre.toLowerCase().includes(state.filters.search.toLowerCase()))
            );
            
            el.emptyState.hidden = filteredItems.length > 0;
            el.tableBody.innerHTML = '';
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img class="thumbnail" src="${item.photoData || 'https://via.placeholder.com/60'}" alt="${item.titre}"></td>
                    <td><b>${item.titre}</b><br><small class="text-secondary">${item.notes.substring(0,50)}${item.notes.length > 50 ? '...' : ''}</small></td>
                    <td><small>Casier: <b>${item.casier}</b></br>Achat: ${item.prixAchat.toFixed(2)}‚Ç¨</small></td>
                    <td><span class="status ${item.vendu ? 'sold' : 'on-sale'}">${item.vendu ? `Vendu (${item.prixVente.toFixed(2)}‚Ç¨)` : 'En vente'}</span></td>
                    <td class="actions-cell"></td>
                `;
                const actionsCell = tr.querySelector('.actions-cell');
                
                const editBtn = document.createElement('button');
                editBtn.title = "√âditer";
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`;
                editBtn.onclick = () => enterEditMode(item.id);

                const saleBtn = document.createElement('button');
                saleBtn.title = item.vendu ? 'Voir vente' : 'Vendre';
                saleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.828-6.491A1.125 1.125 0 0018.02 6H5.25L4.25 3H2.25" /></svg>`;
                saleBtn.onclick = () => openSaleModal(item);

                const deleteBtn = document.createElement('button');
                deleteBtn.title = "Supprimer";
                deleteBtn.classList.add('delete');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                deleteBtn.onclick = () => { if(confirm('Supprimer cet objet ?')) { state.items = state.items.filter(i => i.id !== item.id); saveItems(); render(); }};

                actionsCell.append(editBtn, saleBtn, deleteBtn);
                el.tableBody.appendChild(tr);
            });
        }
        
        function renderStats() {
            const soldItems = state.items.filter(item => item.vendu);
            const stockCount = state.items.length - soldItems.length;
            const revenue = soldItems.reduce((sum, item) => sum + (Number(item.prixVente) || 0), 0);
            const profit = revenue - soldItems.reduce((sum, item) => sum + (Number(item.prixAchat) || 0), 0);
            
            el.statEnStock.textContent = stockCount;
            el.statVendus.textContent = soldItems.length;
            el.statCA.textContent = `${revenue.toFixed(2)} ‚Ç¨`;
            el.statMarge.textContent = `${profit.toFixed(2)} ‚Ç¨`;
        }

        // --- Event Listeners & Initialization ---

        function setupEventListeners() {
            el.form.addEventListener('submit', e => {
                e.preventDefault();
                const formData = {
                    titre: el.titre.value.trim(),
                    casier: el.casier.value.trim(),
                    prixAchat: Number(el.prixAchat.value),
                    dateAchat: el.dateAchat.value,
                    notes: el.notes.value.trim(),
                    photoData: el.previewImage.dataset.imageData || null,
                };

                if (state.isEditMode) {
                    const index = state.items.findIndex(i => i.id === el.editItemId.value);
                    if (index > -1) state.items[index] = { ...state.items[index], ...formData };
                } else {
                    const newItem = { ...formData, id: crypto.randomUUID(), vendu: false, createdAt: new Date().toISOString() };
                    state.items.unshift(newItem);
                }
                saveItems();
                render();
                resetForm();
            });

            el.cancelEditBtn.addEventListener('click', resetForm);
            el.photoInput.addEventListener('change', handlePhotoChange);
            ['searchInput', 'filterCasier', 'filterStatus'].forEach(id => {
                document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', e => {
                    const filterKey = id.replace('filter', '').toLowerCase().replace('searchinput', 'search');
                    state.filters[filterKey] = e.target.value;
                    renderTable();
                });
            });

            el.exportCsv.addEventListener('click', () => { /* CSV Export Logic */ });
            el.saleModal.addEventListener('click', e => { if (e.target === el.saleModal || e.target.classList.contains('close-modal')) el.saleModal.classList.remove('visible'); });
            
            el.saleForm.addEventListener('submit', e => {
                e.preventDefault();
                const updates = {
                    vendu: true,
                    prixVente: Number(el.salePrice.value),
                    dateVente: el.saleDate.value,
                    plateforme: el.salePlatform.value
                };
                const index = state.items.findIndex(i => i.id === el.saleItemId.value);
                if (index > -1) state.items[index] = { ...state.items[index], ...updates };
                saveItems();
                render();
                el.saleModal.classList.remove('visible');
            });

            el.markAvailableBtn.addEventListener('click', () => {
                const updates = { vendu: false, prixVente: null, dateVente: '', plateforme: '' };
                const index = state.items.findIndex(i => i.id === el.saleItemId.value);
                if (index > -1) state.items[index] = { ...state.items[index], ...updates };
                saveItems();
                render();
                el.saleModal.classList.remove('visible');
            });
        }
        
        function openSaleModal(item) {
            el.saleModal.classList.add('visible');
            el.saleItemId.value = item.id;
            el.salePrice.value = item.prixVente ?? '';
            el.saleDate.value = item.dateVente || new Date().toISOString().split('T')[0];
            el.salePlatform.value = item.plateforme || 'Autre';
            el.markAvailableBtn.style.display = item.vendu ? 'inline-flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
            render();
            setupEventListeners();
            loadMobilenet();
        });
    </script>
</body>
</html>