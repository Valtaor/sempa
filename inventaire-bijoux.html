<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Bijoux</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fcfbf7;
            --surface: #ffffff;
            --surface-alt: #f6f1e4;
            --border: #e6dfd1;
            --shadow: 0 18px 40px rgba(110, 97, 73, 0.12);
            --text: #2f2a1f;
            --muted: #7c7365;
            --primary: #c79a32;
            --primary-dark: #a87e1f;
            --success-bg: #ecf8f0;
            --success-text: #1f7a46;
            --danger-bg: #fdeceb;
            --danger-text: #c44444;
            --warning-bg: #fff4df;
            --warning-text: #ad6600;
            --info-bg: #edf4ff;
            --info-text: #255caa;
            --radius-lg: 22px;
            --radius-md: 16px;
            --radius-sm: 10px;
            --transition: all 0.18s ease;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, var(--surface-alt), var(--bg));
            color: var(--text);
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 3rem 1.5rem 2rem;
        }

        header h1 {
            margin: 0;
            font-size: clamp(2.1rem, 5vw, 3.1rem);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        header p {
            max-width: 720px;
            margin: 0.8rem auto 0;
            font-size: 1.02rem;
            color: var(--muted);
        }

        main {
            padding: 0 1.5rem 3.5rem;
            max-width: 1280px;
            margin: 0 auto;
        }

        .layout {
            display: grid;
            gap: 1.75rem;
        }

        @media (min-width: 1100px) {
            .layout {
                grid-template-columns: minmax(340px, 380px) 1fr;
                align-items: start;
            }
        }

        .panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.75rem;
            border: 1px solid rgba(199, 154, 50, 0.12);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.45rem;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            background: rgba(199, 154, 50, 0.12);
            color: var(--primary-dark);
        }

        form label {
            display: block;
            font-weight: 600;
            font-size: 0.92rem;
            margin-bottom: 0.35rem;
        }

        form input[type="text"],
        form input[type="number"],
        form textarea,
        form select {
            width: 100%;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.92);
            padding: 0.72rem 0.85rem;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        form input[type="text"]:focus,
        form input[type="number"]:focus,
        form textarea:focus,
        form select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(199, 154, 50, 0.18);
        }

        .field-group {
            margin-bottom: 1.1rem;
        }

        .inline-fields {
            display: grid;
            gap: 0.9rem;
        }

        @media (min-width: 720px) {
            .inline-fields {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        .checkbox {
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            font-weight: 500;
            font-size: 0.92rem;
        }

        .checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1.1rem;
        }

        button,
        .button {
            border: none;
            border-radius: 999px;
            padding: 0.65rem 1.2rem;
            font-weight: 600;
            font-size: 0.92rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            transition: var(--transition);
        }

        button.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: 0 16px 24px rgba(168, 126, 31, 0.28);
        }

        button.primary:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        button.secondary,
        .button.secondary {
            background: rgba(199, 154, 50, 0.14);
            color: var(--primary-dark);
        }

        button.ghost {
            background: rgba(47, 42, 31, 0.05);
            color: var(--text);
        }

        button.danger {
            background: var(--danger-bg);
            color: var(--danger-text);
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .photo-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 0.55rem;
        }

        .photo-placeholder {
            margin: 0;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .photo-thumb {
            position: relative;
            border: 1px solid rgba(47, 42, 31, 0.08);
            border-radius: 14px;
            overflow: hidden;
            padding: 0;
            width: 72px;
            height: 72px;
            background: #fff;
        }

        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-thumb__remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(47, 42, 31, 0.7);
            color: #fff;
            display: grid;
            place-items: center;
            font-size: 0.85rem;
        }

        .title-alert {
            display: none;
            margin-top: 0.65rem;
            padding: 0.75rem 0.85rem;
            background: var(--warning-bg);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(173, 102, 0, 0.26);
            color: var(--warning-text);
            font-size: 0.88rem;
        }

        .title-alert.show {
            display: block;
        }

        .inventory-summary {
            display: grid;
            gap: 0.9rem;
            margin-bottom: 1.25rem;
        }

        @media (min-width: 640px) {
            .inventory-summary {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .summary-item {
            background: var(--surface-alt);
            border-radius: var(--radius-md);
            padding: 0.9rem 1rem;
            border: 1px solid rgba(199, 154, 50, 0.12);
        }

        .summary-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
            display: block;
            margin-bottom: 0.35rem;
        }

        .summary-value {
            font-size: 1.35rem;
            font-weight: 700;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-bottom: 1.1rem;
        }

        .filters button {
            background: rgba(199, 154, 50, 0.14);
            color: var(--primary-dark);
            font-size: 0.85rem;
        }

        .filters button.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
        }

        .import-export {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-bottom: 1.1rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.28rem 0.65rem;
        }

        .badge.warning {
            background: var(--warning-bg);
            color: var(--warning-text);
        }

        .badge.danger {
            background: var(--danger-bg);
            color: var(--danger-text);
        }

        .badge.muted {
            background: rgba(47, 42, 31, 0.08);
            color: var(--muted);
        }

        .alert-panel {
            display: none;
            background: var(--warning-bg);
            border-radius: var(--radius-md);
            padding: 0.95rem 1.1rem;
            border: 1px solid rgba(173, 102, 0, 0.32);
            color: var(--warning-text);
            margin-bottom: 1.2rem;
        }

        .alert-panel.show {
            display: block;
        }

        .alert-panel ul {
            padding-left: 1.1rem;
            margin: 0.55rem 0 0;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 780px;
        }

        th, td {
            text-align: left;
            padding: 0.75rem 0.85rem;
            border-bottom: 1px solid rgba(47, 42, 31, 0.08);
            font-size: 0.92rem;
            vertical-align: top;
        }

        th {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.07em;
            color: var(--muted);
        }

        td strong {
            display: block;
            margin-bottom: 0.35rem;
        }

        .thumbnail {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 14px;
            border: 1px solid rgba(47, 42, 31, 0.1);
        }

        .avatar-placeholder {
            width: 64px;
            height: 64px;
            border-radius: 14px;
            background: rgba(47, 42, 31, 0.06);
            display: grid;
            place-items: center;
            font-size: 0.75rem;
            color: var(--muted);
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .chip {
            padding: 0.3rem 0.55rem;
            border-radius: 999px;
            background: rgba(47, 42, 31, 0.08);
            font-size: 0.75rem;
        }

        .chip.info {
            background: var(--info-bg);
            color: var(--info-text);
        }

        .item-meta {
            font-size: 0.78rem;
            color: var(--muted);
            margin-top: 0.4rem;
        }

        .action-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .action-group button {
            font-size: 0.78rem;
            padding: 0.42rem 0.65rem;
            border-radius: 999px;
            border: 1px solid transparent;
            background: rgba(47, 42, 31, 0.05);
            color: var(--text);
        }

        .action-group button[data-variant="positive"] {
            background: var(--success-bg);
            color: var(--success-text);
        }

        .action-group button[data-variant="danger"] {
            background: var(--danger-bg);
            color: var(--danger-text);
        }

        .action-group button[data-variant="warning"] {
            background: var(--warning-bg);
            color: var(--warning-text);
        }

        .action-group button[data-variant="info"] {
            background: var(--info-bg);
            color: var(--info-text);
        }

        .action-group button[data-variant="ghost"] {
            background: rgba(47, 42, 31, 0.05);
            color: var(--text);
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 1.8rem 1rem;
            font-size: 0.95rem;
            color: var(--muted);
        }

        tr.low-stock td {
            background: rgba(255, 244, 223, 0.32);
        }

        tr.out-of-stock td {
            background: rgba(253, 236, 235, 0.32);
        }

        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 0.85rem 1.1rem;
            border-radius: var(--radius-sm);
            background: var(--surface);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            display: none;
            max-width: 320px;
            font-weight: 500;
        }

        .toast.show {
            display: block;
        }

        .toast.error {
            border-left-color: var(--danger-text);
        }

        .toast.success {
            border-left-color: var(--success-text);
        }

        .toast.warning {
            border-left-color: var(--warning-text);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(32, 28, 18, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 30;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            width: min(640px, 100%);
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .history-list {
            display: grid;
            gap: 0.8rem;
        }

        .history-item {
            background: rgba(47, 42, 31, 0.05);
            border-radius: var(--radius-md);
            padding: 0.9rem 1rem;
            border: 1px solid rgba(47, 42, 31, 0.08);
        }

        .history-item strong {
            display: block;
            margin-bottom: 0.3rem;
        }

        .history-item small {
            color: var(--muted);
        }

        .quantity-form {
            display: grid;
            gap: 1rem;
        }

        .quantity-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .quantity-input input {
            flex: 1;
            min-width: 0;
        }

        .quantity-input button {
            padding: 0.55rem 0.75rem;
            border-radius: var(--radius-sm);
            background: rgba(47, 42, 31, 0.06);
            color: var(--text);
        }

        .helper-text {
            margin: 0;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.65rem;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (max-width: 780px) {
            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead {
                display: none;
            }

            tr {
                border: 1px solid rgba(47, 42, 31, 0.08);
                border-radius: var(--radius-md);
                padding: 1rem;
                margin-bottom: 1rem;
                background: rgba(255, 255, 255, 0.96);
            }

            td {
                border: none;
                padding: 0.4rem 0;
            }

            td::before {
                content: attr(data-label);
                display: block;
                font-size: 0.75rem;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                color: var(--muted);
                margin-bottom: 0.25rem;
            }

            .table-wrapper {
                overflow: visible;
            }
        }

        body.modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <header>
        <h1>Inventaire Bijoux</h1>
        <p>Générez automatiquement des titres harmonisés, ajustez vos stocks et suivez l'historique complet de chaque bijou en toute simplicité.</p>
    </header>
    <main>
        <section class="layout">
            <article class="panel form-panel" aria-label="Formulaire de bijou">
                <div class="panel-header">
                    <h2>Fiche bijou</h2>
                    <span class="tag" id="mode-badge">Nouveau</span>
                </div>
                <form id="bijou-form">
                    <input type="hidden" id="bijou-id">
                    <div class="field-group">
                        <label for="type">Type *</label>
                        <select id="type" required>
                            <option value="">Sélectionner</option>
                            <option value="collier">Collier</option>
                            <option value="boucles">Boucles</option>
                            <option value="bracelet">Bracelet</option>
                        </select>
                    </div>
                    <div class="field-group inline-fields">
                        <div>
                            <label for="matiere">Matière *</label>
                            <input type="text" id="matiere" required placeholder="Argent 925, Or 18k...">
                        </div>
                        <div>
                            <label for="caracteristique">Caractéristique principale *</label>
                            <input type="text" id="caracteristique" required placeholder="Perle, pendentif...">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="dimensions">Dimensions (cm) *</label>
                        <input type="text" id="dimensions" required placeholder="Longueur 45 cm / pendentif 1.8×1.2 cm">
                    </div>
                    <div class="field-group inline-fields">
                        <div>
                            <label for="couleur">Couleur</label>
                            <input type="text" id="couleur" placeholder="Argent, Doré...">
                        </div>
                        <div>
                            <label for="couleurs">Couleur(s) complémentaire(s)</label>
                            <input type="text" id="couleurs" placeholder="Rose gold, perle ivoire...">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="photos">Photos</label>
                        <input type="file" id="photos" accept="image/*" multiple>
                        <div class="photo-previews" id="photo-previews">
                            <p class="photo-placeholder">Aucune photo ajoutée pour le moment.</p>
                        </div>
                    </div>
                    <div class="field-group inline-fields">
                        <div>
                            <label for="quantite">Quantité *</label>
                            <input type="number" id="quantite" min="0" value="0" required>
                        </div>
                        <div>
                            <label for="seuil_bas">Seuil bas</label>
                            <input type="number" id="seuil_bas" min="0" value="0">
                        </div>
                        <div>
                            <label for="prix_achat">Prix d'achat (€)</label>
                            <input type="number" step="0.01" min="0" id="prix_achat" placeholder="Optionnel">
                        </div>
                    </div>
                    <div class="field-group inline-fields">
                        <div>
                            <label for="marque">Marque</label>
                            <input type="text" id="marque" placeholder="Optionnel">
                        </div>
                        <div>
                            <label for="etat">État</label>
                            <input type="text" id="etat" placeholder="Neuf, Excellent...">
                        </div>
                        <div>
                            <label for="defauts">Défauts</label>
                            <input type="text" id="defauts" placeholder="Optionnel">
                        </div>
                    </div>
                    <div class="field-group">
                        <label class="checkbox">
                            <input type="checkbox" id="flag_a_renseigner">
                            Informations à compléter
                        </label>
                    </div>
                    <div class="field-group">
                        <label for="titre_court">Titre automatique</label>
                        <div class="actions" style="margin-top: 0.45rem;">
                            <button type="button" class="secondary" id="btn-generer-titre">Générer automatiquement</button>
                            <button type="button" class="ghost" id="btn-historique-titres">Historique des titres</button>
                        </div>
                        <input type="text" id="titre_court" placeholder="Titre d'affichage">
                        <div class="title-alert" id="titre-alert">Impossible de générer un titre : complétez les champs requis ou saisissez un titre personnalisé.</div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="primary" id="btn-enregistrer">Enregistrer</button>
                        <button type="button" class="ghost" id="btn-annuler">Réinitialiser</button>
                    </div>
                </form>
            </article>
            <article class="panel inventory-panel" aria-label="Inventaire">
                <div class="panel-header">
                    <h2>Inventaire</h2>
                    <span class="tag" id="inventaire-total">0 fiche</span>
                </div>
                <div class="inventory-summary" aria-live="polite">
                    <div class="summary-item">
                        <span class="summary-label">Pièces en stock</span>
                        <strong class="summary-value" id="summary-quantite">0</strong>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">À surveiller</span>
                        <strong class="summary-value" id="summary-low">0</strong>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Épuisés</span>
                        <strong class="summary-value" id="summary-out">0</strong>
                    </div>
                </div>
                <div class="alert-panel" id="alert-panel" role="alert" aria-live="assertive"></div>
                <div class="filters" role="tablist" aria-label="Filtres d'état">
                    <button type="button" class="active" data-filter="all">Tous</button>
                    <button type="button" data-filter="stock">En stock</button>
                    <button type="button" data-filter="low">À réapprovisionner</button>
                    <button type="button" data-filter="out">Épuisés</button>
                </div>
                <div class="import-export">
                    <label class="button secondary" for="csv-import">Importer CSV</label>
                    <input type="file" id="csv-import" accept=".csv" hidden>
                    <button type="button" class="ghost" id="btn-export">Exporter CSV</button>
                    <span class="chip info">Token API : inventaire-bijoux-token</span>
                </div>
                <div class="table-wrapper">
                    <table aria-live="polite">
                        <thead>
                            <tr>
                                <th scope="col">Photo</th>
                                <th scope="col">Titre &amp; détails</th>
                                <th scope="col">Type</th>
                                <th scope="col">Matière</th>
                                <th scope="col">Qté</th>
                                <th scope="col">Seuil</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventaire-body"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="empty-state" aria-live="polite">Ajoutez votre premier bijou pour le suivre ici.</div>
            </article>
        </section>
    </main>
    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="modal" id="history-modal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Historique des mouvements</h3>
                <button type="button" class="ghost" id="close-history">Fermer</button>
            </div>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>
    <div class="modal" id="title-history-modal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Historique des titres</h3>
                <button type="button" class="ghost" id="close-title-history">Fermer</button>
            </div>
            <div class="history-list" id="title-history-list"></div>
        </div>
    </div>
    <div class="modal" id="quantity-modal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="quantity-modal-title">Ajuster la quantité</h3>
                <button type="button" class="ghost" data-close="quantity">Fermer</button>
            </div>
            <form class="quantity-form" id="quantity-form">
                <div>
                    <label for="quantity-value">Quantité</label>
                    <div class="quantity-input">
                        <button type="button" data-adjust="-1" aria-label="Retirer 1">−</button>
                        <input type="number" id="quantity-value" min="0" value="1" required>
                        <button type="button" data-adjust="1" aria-label="Ajouter 1">+</button>
                    </div>
                </div>
                <p class="helper-text" id="quantity-helper"></p>
                <div class="modal-actions">
                    <button type="button" class="ghost" data-close="quantity">Annuler</button>
                    <button type="submit" class="primary">Valider</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const API_BASE = 'api/bijoux.php';
        const API_TOKEN = 'inventaire-bijoux-token';
        const DEFAULT_USER = 'admin';

        const form = document.getElementById('bijou-form');
        const modeBadge = document.getElementById('mode-badge');
        const inventaireBody = document.getElementById('inventaire-body');
        const inventaireTotal = document.getElementById('inventaire-total');
        const summaryQuantite = document.getElementById('summary-quantite');
        const summaryLow = document.getElementById('summary-low');
        const summaryOut = document.getElementById('summary-out');
        const emptyState = document.getElementById('empty-state');
        const alertPanel = document.getElementById('alert-panel');
        const toast = document.getElementById('toast');
        const photoInput = document.getElementById('photos');
        const photoPreview = document.getElementById('photo-previews');
        const csvImport = document.getElementById('csv-import');
        const historyModal = document.getElementById('history-modal');
        const historyList = document.getElementById('history-list');
        const titleHistoryModal = document.getElementById('title-history-modal');
        const titleHistoryList = document.getElementById('title-history-list');
        const titleAlert = document.getElementById('titre-alert');
        const submitButton = document.getElementById('btn-enregistrer');
        const quantityModal = document.getElementById('quantity-modal');
        const quantityForm = document.getElementById('quantity-form');
        const quantityTitle = document.getElementById('quantity-modal-title');
        const quantityInput = document.getElementById('quantity-value');
        const quantityHelper = document.getElementById('quantity-helper');

        let bijoux = [];
        let currentFilter = 'all';
        let currentPhotos = [];
        let manualTitle = false;
        let pendingStockAction = null;
        let toastTimeout;

        const fields = {
            id: document.getElementById('bijou-id'),
            type: document.getElementById('type'),
            matiere: document.getElementById('matiere'),
            caracteristique: document.getElementById('caracteristique'),
            dimensions: document.getElementById('dimensions'),
            couleur: document.getElementById('couleur'),
            couleurs: document.getElementById('couleurs'),
            quantite: document.getElementById('quantite'),
            seuil_bas: document.getElementById('seuil_bas'),
            prix_achat: document.getElementById('prix_achat'),
            flag: document.getElementById('flag_a_renseigner'),
            titre_court: document.getElementById('titre_court'),
            marque: document.getElementById('marque'),
            etat: document.getElementById('etat'),
            defauts: document.getElementById('defauts')
        };

        const STOCK_LABELS = {
            add: {
                title: 'Ajouter au stock',
                helper: 'Indiquez combien de pièces ajouter à la quantité actuelle.',
                min: 1,
                variant: 'positive'
            },
            remove: {
                title: 'Retirer du stock',
                helper: 'Retirez des pièces sans passer par la vente.',
                min: 1,
                variant: 'danger'
            },
            reserve: {
                title: 'Réserver',
                helper: 'Réservez des pièces pour une commande ou un shooting.',
                min: 1,
                variant: 'warning'
            },
            sold: {
                title: 'Marquer comme vendu',
                helper: 'Décrémentez le stock après une vente.',
                min: 1,
                variant: 'danger'
            },
            set: {
                title: 'Définir une quantité exacte',
                helper: 'Fixez manuellement la quantité totale après audit.',
                min: 0,
                variant: 'info'
            }
        };

        function escapeHtml(value) {
            return (value ?? '').toString().replace(/[&<>"']/g, (char) => {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function escapeAttribute(value) {
            return escapeHtml(value).replace(/`/g, '&#96;');
        }

        function formatPrice(value) {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return '';
            }
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(number);
        }

        function formatDate(value) {
            if (!value) {
                return '-';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }
            return date.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
        }

        function showToast(message, type = 'info') {
            clearTimeout(toastTimeout);
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3200);
        }

        async function apiFetch(path, options = {}) {
            const headers = { ...(options.headers || {}) };
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = headers['Content-Type'] || 'application/json';
            }
            headers['Authorization'] = 'Bearer ' + API_TOKEN;
            headers['X-User'] = DEFAULT_USER;
            const response = await fetch(`${API_BASE}${path}`, {
                credentials: 'omit',
                ...options,
                headers
            });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || 'Erreur API');
            }
            const contentType = response.headers.get('Content-Type') || '';
            if (contentType.includes('application/json')) {
                return response.json();
            }
            return response;
        }

        function resetForm() {
            form.reset();
            fields.id.value = '';
            fields.quantite.value = '0';
            fields.seuil_bas.value = '0';
            fields.prix_achat.value = '';
            manualTitle = false;
            currentPhotos = [];
            renderPhotos();
            titleAlert.classList.remove('show');
            modeBadge.textContent = 'Nouveau';
            submitButton.disabled = false;
            submitButton.textContent = 'Enregistrer';
        }

        function renderPhotos() {
            if (!currentPhotos.length) {
                photoPreview.innerHTML = '<p class="photo-placeholder">Aucune photo ajoutée pour le moment.</p>';
                return;
            }
            photoPreview.innerHTML = currentPhotos.map((src, index) => `
                <button type="button" class="photo-thumb" data-photo-index="${index}" aria-label="Retirer la photo ${index + 1}">
                    <img src="${escapeAttribute(src)}" alt="Photo bijou ${index + 1}" loading="lazy">
                    <span class="photo-thumb__remove" aria-hidden="true">×</span>
                </button>
            `).join('');
        }

        function extractPrimaryDimension(dimensions) {
            if (!dimensions) return '';
            const parts = dimensions.split(/[\/]/);
            return parts[0]?.trim() || dimensions.trim();
        }

        function generateTitlesFromValues(type, matiere, caracteristique, dimensions) {
            if (!type || !matiere || !caracteristique || !dimensions) {
                return { titre_court: '', avertissement: true };
            }
            const dimensionPrincipale = extractPrimaryDimension(dimensions);
            if (!dimensionPrincipale) {
                return { titre_court: '', avertissement: true };
            }
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            const titreCourt = `${typeLabel} ${matiere} ${caracteristique} ${dimensionPrincipale}`.replace(/\s+/g, ' ').trim();
            return { titre_court: titreCourt, avertissement: false };
        }

        function generateTitlesFromForm({ force = false } = {}) {
            const result = generateTitlesFromValues(
                fields.type.value,
                fields.matiere.value.trim(),
                fields.caracteristique.value.trim(),
                fields.dimensions.value.trim()
            );
            if (result.titre_court && (!manualTitle || force)) {
                fields.titre_court.value = result.titre_court;
                manualTitle = false;
            }
            const showWarning = result.avertissement && fields.titre_court.value.trim() === '';
            titleAlert.classList.toggle('show', showWarning);
            if (force && result.avertissement) {
                showToast('Complétez les champs requis pour générer un titre.', 'warning');
            }
            if (force && !result.avertissement) {
                showToast('Titre généré automatiquement.', 'success');
            }
            return result;
        }

        async function loadBijoux() {
            try {
                const data = await apiFetch('?resource=bijoux');
                const list = Array.isArray(data.bijoux) ? data.bijoux : [];
                bijoux = list.slice().sort((a, b) => {
                    const aTitle = (a.titre_court || '').toString().toLowerCase();
                    const bTitle = (b.titre_court || '').toString().toLowerCase();
                    return aTitle.localeCompare(bTitle, 'fr', { sensitivity: 'base' });
                });
                renderInventory();
            } catch (error) {
                console.error(error);
                showToast('Impossible de charger les bijoux.', 'error');
            }
        }

        function renderAlerts() {
            const lowStock = bijoux.filter(item => Number(item.seuil_bas) > 0 && Number(item.quantite) > 0 && Number(item.quantite) <= Number(item.seuil_bas));
            const outOfStock = bijoux.filter(item => Number(item.quantite) === 0);
            if (!lowStock.length && !outOfStock.length) {
                alertPanel.classList.remove('show');
                alertPanel.innerHTML = '';
                return;
            }
            const parts = [];
            if (lowStock.length) {
                parts.push(`<strong>${lowStock.length} bijou${lowStock.length > 1 ? 'x' : ''} proche du seuil :</strong>`);
                parts.push('<ul>' + lowStock.map(item => `<li>${escapeHtml(item.titre_court || item.id)} — ${Number(item.quantite)} pièce(s) (seuil ${Number(item.seuil_bas)})</li>`).join('') + '</ul>');
            }
            if (outOfStock.length) {
                parts.push(`<strong>${outOfStock.length} bijou${outOfStock.length > 1 ? 'x' : ''} épuisé${outOfStock.length > 1 ? 's' : ''} :</strong>`);
                parts.push('<ul>' + outOfStock.map(item => `<li>${escapeHtml(item.titre_court || item.id)}</li>`).join('') + '</ul>');
            }
            alertPanel.innerHTML = parts.join('');
            alertPanel.classList.add('show');
        }

        function filteredBijoux() {
            return bijoux.filter(item => {
                const quantite = Number(item.quantite) || 0;
                const seuil = Number(item.seuil_bas) || 0;
                if (currentFilter === 'low') {
                    return seuil > 0 && quantite > 0 && quantite <= seuil;
                }
                if (currentFilter === 'out') {
                    return quantite === 0;
                }
                if (currentFilter === 'stock') {
                    return quantite > seuil;
                }
                return true;
            });
        }

        function getEmptyMessage() {
            switch (currentFilter) {
                case 'stock':
                    return 'Aucun bijou avec un stock confortable pour le moment.';
                case 'low':
                    return 'Aucun bijou à réapprovisionner pour le moment.';
                case 'out':
                    return 'Aucun bijou épuisé, bravo !';
                default:
                    return 'Ajoutez votre premier bijou pour le suivre ici.';
            }
        }

        function renderInventory() {
            renderAlerts();
            const list = filteredBijoux();
            const totalPieces = bijoux.reduce((sum, item) => sum + (Number(item.quantite) || 0), 0);
            const lowCount = bijoux.filter(item => Number(item.seuil_bas) > 0 && Number(item.quantite) > 0 && Number(item.quantite) <= Number(item.seuil_bas)).length;
            const outCount = bijoux.filter(item => Number(item.quantite) === 0).length;
            summaryQuantite.textContent = totalPieces;
            summaryLow.textContent = lowCount;
            summaryOut.textContent = outCount;
            inventaireTotal.textContent = `${bijoux.length} fiche${bijoux.length > 1 ? 's' : ''}`;
            emptyState.textContent = getEmptyMessage();
            emptyState.style.display = list.length === 0 ? 'block' : 'none';

            inventaireBody.innerHTML = list.map(item => {
                const id = escapeHtml(item.id || '');
                const titre = escapeHtml(item.titre_court || 'Titre à renseigner');
                const type = escapeHtml(item.type || '');
                const matiere = escapeHtml(item.matiere || '');
                const dimensions = escapeHtml(item.dimensions || '');
                const couleur = escapeHtml(item.couleur || '');
                const couleurs = escapeHtml(item.couleurs || '');
                const marque = escapeHtml(item.marque || '');
                const etat = escapeHtml(item.etat || '');
                const defauts = escapeHtml(item.defauts || '');
                const prix = formatPrice(item.prix_achat);
                const quantite = Number(item.quantite) || 0;
                const seuil = Number(item.seuil_bas) || 0;
                const badge = quantite === 0
                    ? '<span class="badge danger">Épuisé</span>'
                    : (seuil > 0 && quantite <= seuil
                        ? '<span class="badge warning">Seuil bas</span>'
                        : '');
                const rowClass = quantite === 0 ? 'out-of-stock' : (seuil > 0 && quantite <= seuil ? 'low-stock' : '');
                const photo = Array.isArray(item.photos) && item.photos.length
                    ? `<img src="${escapeAttribute(item.photos[0])}" alt="${titre}" class="thumbnail">`
                    : '<div class="avatar-placeholder">Pas de photo</div>';
                const chips = [];
                if (dimensions) chips.push(`<span class="chip">${dimensions}</span>`);
                if (couleur) chips.push(`<span class="chip">${couleur}</span>`);
                if (couleurs) chips.push(`<span class="chip">${couleurs}</span>`);
                if (prix) chips.push(`<span class="chip info">Achat ${escapeHtml(prix)}</span>`);
                if (item.flag_a_renseigner) chips.push('<span class="chip">À compléter</span>');
                if (marque) chips.push(`<span class="chip">${marque}</span>`);
                const meta = formatDate(item.updated_at);
                const etatText = etat ? `<div class="item-meta">État : ${etat}</div>` : '';
                const defautsText = defauts ? `<div class="item-meta">Défauts : ${defauts}</div>` : '';

                return `
                    <tr class="${rowClass}">
                        <td data-label="Photo">${photo}</td>
                        <td data-label="Titre">
                            <strong>${titre}</strong>
                            ${badge}
                            ${chips.length ? `<div class="chips">${chips.join('')}</div>` : ''}
                            ${etatText}
                            ${defautsText}
                            <div class="item-meta">MàJ : ${escapeHtml(meta)}</div>
                        </td>
                        <td data-label="Type">${type}</td>
                        <td data-label="Matière">${matiere}</td>
                        <td data-label="Quantité">${quantite}</td>
                        <td data-label="Seuil">${seuil}</td>
                        <td data-label="Actions">
                            <div class="action-group" role="group" aria-label="Actions stock">
                                <button type="button" data-action="add" data-id="${id}" data-variant="positive">Ajouter</button>
                                <button type="button" data-action="remove" data-id="${id}" data-variant="danger">Retirer</button>
                                <button type="button" data-action="reserve" data-id="${id}" data-variant="warning">Réserver</button>
                                <button type="button" data-action="sold" data-id="${id}" data-variant="danger">Vendu</button>
                                <button type="button" data-action="set" data-id="${id}" data-variant="info">Définir</button>
                                <button type="button" data-action="history" data-id="${id}" data-variant="ghost">Historique</button>
                                <button type="button" data-action="edit" data-id="${id}" data-variant="ghost">Éditer</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getFormPayload() {
            const titreGeneration = generateTitlesFromValues(
                fields.type.value,
                fields.matiere.value.trim(),
                fields.caracteristique.value.trim(),
                fields.dimensions.value.trim()
            );
            const titreAvertissement = titreGeneration.avertissement && fields.titre_court.value.trim() === '';
            return {
                id: fields.id.value,
                type: fields.type.value,
                matiere: fields.matiere.value.trim(),
                caracteristique: fields.caracteristique.value.trim(),
                dimensions: fields.dimensions.value.trim(),
                couleur: fields.couleur.value.trim(),
                couleurs: fields.couleurs.value.trim(),
                photos: currentPhotos,
                quantite: Number(fields.quantite.value || 0),
                seuil_bas: Number(fields.seuil_bas.value || 0),
                prix_achat: fields.prix_achat.value !== '' ? Number(fields.prix_achat.value) : null,
                flag_a_renseigner: fields.flag.checked,
                titre_court: fields.titre_court.value.trim(),
                titre_avertissement: titreAvertissement,
                marque: fields.marque.value.trim(),
                etat: fields.etat.value.trim(),
                defauts: fields.defauts.value.trim()
            };
        }

        function populateForm(bijou) {
            fields.id.value = bijou.id || '';
            fields.type.value = bijou.type || '';
            fields.matiere.value = bijou.matiere || '';
            fields.caracteristique.value = bijou.caracteristique || '';
            fields.dimensions.value = bijou.dimensions || '';
            fields.couleur.value = bijou.couleur || '';
            fields.couleurs.value = bijou.couleurs || '';
            fields.quantite.value = Number(bijou.quantite ?? 0);
            fields.seuil_bas.value = Number(bijou.seuil_bas ?? 0);
            fields.prix_achat.value = bijou.prix_achat ?? '';
            fields.flag.checked = Boolean(bijou.flag_a_renseigner);
            fields.titre_court.value = bijou.titre_court || '';
            fields.marque.value = bijou.marque || '';
            fields.etat.value = bijou.etat || '';
            fields.defauts.value = bijou.defauts || '';
            manualTitle = fields.titre_court.value.trim() !== '';
            currentPhotos = Array.isArray(bijou.photos) ? bijou.photos.slice() : [];
            renderPhotos();
            modeBadge.textContent = 'Édition';
            titleAlert.classList.toggle('show', Boolean(bijou.titre_avertissement && !fields.titre_court.value.trim()));
        }

        function setFormLoading(loading) {
            submitButton.disabled = loading;
            submitButton.textContent = loading ? 'Enregistrement…' : 'Enregistrer';
        }

        async function submitForm(event) {
            event.preventDefault();
            if (!form.reportValidity()) {
                return;
            }
            const payload = getFormPayload();
            const method = payload.id ? 'PUT' : 'POST';
            const path = payload.id ? `?resource=bijoux&id=${encodeURIComponent(payload.id)}` : '?resource=bijoux';
            try {
                setFormLoading(true);
                await apiFetch(path, {
                    method,
                    body: JSON.stringify(payload)
                });
                showToast('Bijou enregistré.', 'success');
                resetForm();
                await loadBijoux();
            } catch (error) {
                console.error(error);
                showToast('Erreur lors de l\'enregistrement.', 'error');
            } finally {
                setFormLoading(false);
            }
        }

        function openModal(modal) {
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
        }

        function closeModal(modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        function openHistory(id) {
            apiFetch(`?resource=historique&bijou_id=${encodeURIComponent(id)}&per_page=50`).then(data => {
                const items = Array.isArray(data.logs) ? data.logs : [];
                historyList.innerHTML = items.length
                    ? items.map(log => `
                        <div class="history-item">
                            <strong>${escapeHtml(log.action.toUpperCase())}</strong>
                            <div>Variation : ${log.delta > 0 ? '+' : ''}${log.delta}</div>
                            <div>Nouvelle quantité : ${log.nouvelle_quantite}</div>
                            <small>${escapeHtml(new Date(log.timestamp).toLocaleString('fr-FR'))} – ${escapeHtml(log.utilisateur)}</small>
                        </div>
                    `).join('')
                    : '<p>Aucune opération enregistrée.</p>';
                openModal(historyModal);
            }).catch(error => {
                console.error(error);
                showToast('Historique indisponible.', 'error');
            });
        }

        function openTitleHistory(id) {
            apiFetch(`?resource=titres&bijou_id=${encodeURIComponent(id)}`).then(data => {
                const items = Array.isArray(data.titres) ? data.titres : [];
                titleHistoryList.innerHTML = items.length
                    ? items.map(entry => `
                        <div class="history-item">
                            <strong>${escapeHtml(entry.champ)}</strong>
                            <div>Ancien : ${entry.ancienne_valeur ? escapeHtml(entry.ancienne_valeur) : '<em>vide</em>'}</div>
                            <div>Nouveau : ${entry.nouvelle_valeur ? escapeHtml(entry.nouvelle_valeur) : '<em>vide</em>'}</div>
                            <small>${escapeHtml(new Date(entry.timestamp).toLocaleString('fr-FR'))} – ${escapeHtml(entry.utilisateur)}</small>
                        </div>
                    `).join('')
                    : '<p>Aucune modification enregistrée.</p>';
                openModal(titleHistoryModal);
            }).catch(error => {
                console.error(error);
                showToast('Historique des titres indisponible.', 'error');
            });
        }

        function closeHistoryModal() {
            closeModal(historyModal);
        }

        function closeTitleHistoryModal() {
            closeModal(titleHistoryModal);
        }

        function closeQuantityModal() {
            closeModal(quantityModal);
            pendingStockAction = null;
            quantityForm.reset();
            quantityHelper.textContent = '';
        }

        function openQuantityModal(action, bijou) {
            const config = STOCK_LABELS[action];
            if (!config) return;
            pendingStockAction = { action, id: bijou.id, max: Number(bijou.quantite) || 0 };
            if (['remove', 'reserve', 'sold'].includes(action) && pendingStockAction.max <= 0) {
                showToast('Stock insuffisant pour cette action.', 'warning');
                pendingStockAction = null;
                return;
            }
            quantityTitle.textContent = config.title;
            const suffix = ['remove', 'reserve', 'sold'].includes(action)
                ? ` Disponible : ${pendingStockAction.max}`
                : (action === 'set' ? ` Quantité actuelle : ${pendingStockAction.max}` : '');
            quantityHelper.textContent = config.helper + suffix;
            quantityInput.min = config.min;
            quantityInput.value = action === 'set' ? pendingStockAction.max : Math.max(config.min, 1);
            quantityInput.focus();
            if (['remove', 'reserve', 'sold'].includes(action)) {
                quantityInput.max = pendingStockAction.max;
            } else {
                quantityInput.removeAttribute('max');
            }
            openModal(quantityModal);
            setTimeout(() => quantityInput.focus(), 50);
        }

        function adjustQuantity(step) {
            const current = Number(quantityInput.value || 0);
            const next = current + step;
            const min = Number(quantityInput.min || 0);
            const maxAttr = quantityInput.getAttribute('max');
            const max = maxAttr !== null ? Number(maxAttr) : Infinity;
            const clamped = Math.min(Math.max(next, min), max);
            quantityInput.value = clamped;
        }

        async function submitQuantity(event) {
            event.preventDefault();
            if (!pendingStockAction) {
                closeQuantityModal();
                return;
            }
            const valeur = Number(quantityInput.value);
            if (!Number.isInteger(valeur) || valeur < Number(quantityInput.min)) {
                showToast('Veuillez saisir une quantité valide.', 'warning');
                return;
            }
            if (quantityInput.hasAttribute('max') && valeur > Number(quantityInput.getAttribute('max'))) {
                showToast('Quantité supérieure au stock disponible.', 'warning');
                return;
            }
            try {
                await apiFetch(`?resource=stock&id=${encodeURIComponent(pendingStockAction.id)}&action=${pendingStockAction.action}`, {
                    method: 'POST',
                    body: JSON.stringify({ valeur })
                });
                showToast('Stock mis à jour.', 'success');
                closeQuantityModal();
                await loadBijoux();
            } catch (error) {
                console.error(error);
                showToast('Impossible de modifier le stock.', 'error');
            }
        }

        function handleTableClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const id = button.dataset.id;
            const bijou = bijoux.find(item => item.id === id);
            if (!bijou) return;
            if (action === 'edit') {
                populateForm(bijou);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            if (action === 'history') {
                openHistory(id);
                return;
            }
            openQuantityModal(action, bijou);
        }

        function handleFilterClick(event) {
            const button = event.target.closest('button[data-filter]');
            if (!button) return;
            currentFilter = button.dataset.filter;
            document.querySelectorAll('.filters button').forEach(btn => btn.classList.toggle('active', btn === button));
            renderInventory();
        }

        photoInput.addEventListener('change', async () => {
            const files = Array.from(photoInput.files || []);
            if (!files.length) return;
            const readers = files.map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }));
            try {
                const images = await Promise.all(readers);
                currentPhotos = currentPhotos.concat(images);
                renderPhotos();
            } catch (error) {
                console.error(error);
                showToast('Erreur lors du chargement des photos.', 'error');
            } finally {
                photoInput.value = '';
            }
        });

        photoPreview.addEventListener('click', event => {
            const button = event.target.closest('[data-photo-index]');
            if (!button) return;
            const index = Number(button.dataset.photoIndex);
            if (Number.isInteger(index)) {
                currentPhotos.splice(index, 1);
                renderPhotos();
                showToast('Photo retirée.', 'info');
            }
        });

        csvImport.addEventListener('change', async () => {
            const file = csvImport.files?.[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('fichier', file);
            try {
                const response = await fetch(`${API_BASE}?resource=import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + API_TOKEN,
                        'X-User': DEFAULT_USER
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const result = await response.json();
                showToast(`Import réussi : ${result.import.crees} créé(s), ${result.import.mis_a_jour} mis à jour.`, 'success');
                await loadBijoux();
            } catch (error) {
                console.error(error);
                showToast('Échec de l\'import CSV.', 'error');
            } finally {
                csvImport.value = '';
            }
        });

        document.getElementById('btn-export').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}?resource=export`, {
                    headers: {
                        'Authorization': 'Bearer ' + API_TOKEN,
                        'X-User': DEFAULT_USER
                    }
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'inventaire_bijoux.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Export CSV généré.', 'success');
            } catch (error) {
                console.error(error);
                showToast('Impossible d\'exporter le CSV.', 'error');
            }
        });

        document.getElementById('btn-generer-titre').addEventListener('click', () => {
            manualTitle = false;
            generateTitlesFromForm({ force: true });
        });

        document.getElementById('btn-historique-titres').addEventListener('click', () => {
            const id = fields.id.value;
            if (!id) {
                showToast('Enregistrez le bijou pour consulter l\'historique des titres.', 'warning');
                return;
            }
            openTitleHistory(id);
        });

        document.getElementById('btn-annuler').addEventListener('click', resetForm);
        document.getElementById('close-history').addEventListener('click', closeHistoryModal);
        document.getElementById('close-title-history').addEventListener('click', closeTitleHistoryModal);
        quantityForm.addEventListener('submit', submitQuantity);
        quantityModal.addEventListener('click', event => {
            if (event.target.dataset.close === 'quantity' || event.target === quantityModal) {
                closeQuantityModal();
            }
        });
        historyModal.addEventListener('click', event => {
            if (event.target === historyModal) closeHistoryModal();
        });
        titleHistoryModal.addEventListener('click', event => {
            if (event.target === titleHistoryModal) closeTitleHistoryModal();
        });
        const decrementButton = quantityForm.querySelector('[data-adjust="-1"]');
        const incrementButton = quantityForm.querySelector('[data-adjust="1"]');
        if (decrementButton) {
            decrementButton.addEventListener('click', () => adjustQuantity(-1));
        }
        if (incrementButton) {
            incrementButton.addEventListener('click', () => adjustQuantity(1));
        }
        form.addEventListener('submit', submitForm);
        inventaireBody.addEventListener('click', handleTableClick);
        document.querySelector('.filters').addEventListener('click', handleFilterClick);

        ['type', 'matiere', 'caracteristique', 'dimensions'].forEach(key => {
            const field = fields[key];
            const eventName = field.tagName === 'SELECT' ? 'change' : 'input';
            field.addEventListener(eventName, () => generateTitlesFromForm());
        });

        fields.titre_court.addEventListener('input', () => {
            manualTitle = fields.titre_court.value.trim() !== '';
            titleAlert.classList.toggle('show', fields.titre_court.value.trim() === '' && generateTitlesFromValues(
                fields.type.value,
                fields.matiere.value.trim(),
                fields.caracteristique.value.trim(),
                fields.dimensions.value.trim()
            ).avertissement);
        });

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                if (historyModal.classList.contains('show')) closeHistoryModal();
                if (titleHistoryModal.classList.contains('show')) closeTitleHistoryModal();
                if (quantityModal.classList.contains('show')) closeQuantityModal();
            }
        });

        resetForm();
        loadBijoux();
    </script>
</body>
</html>
