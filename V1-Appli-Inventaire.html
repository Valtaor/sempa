<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion d'Inventaire Vintage</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --fond: #f4ede3;
            --accent: #9c6b4f;
            --accent-fonce: #7c5234;
            --vert: #6f8b74;
            --bleu: #4f6a6a;
            --texte: #2f2a26;
            --clair: #fdf9f3;
            --ombre: rgba(55, 40, 24, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--fond);
            background-image: radial-gradient(circle at 20% 20%, rgba(124, 82, 52, 0.08), transparent 55%),
                radial-gradient(circle at 80% 0%, rgba(79, 106, 106, 0.08), transparent 60%);
            color: var(--texte);
            font-family: 'Work Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(130deg, rgba(73, 55, 40, 0.94), rgba(158, 120, 88, 0.9));
            padding: 36px 20px 44px;
            color: #fdf6ec;
            text-align: center;
            box-shadow: 0 12px 28px rgba(55, 40, 24, 0.18);
            border-bottom: 1px solid rgba(253, 249, 243, 0.25);
        }

        header h1 {
            margin: 0;
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.1rem, 2vw + 2rem, 3.4rem);
            letter-spacing: 1.5px;
        }

        header p {
            max-width: 680px;
            margin: 14px auto 0;
            font-size: 1rem;
            opacity: 0.85;
        }

        .container {
            width: min(1120px, 92vw);
            margin: -32px auto 64px;
        }

        .card {
            background: var(--clair);
            border-radius: 18px;
            padding: clamp(22px, 2vw + 18px, 34px);
            margin-bottom: 30px;
            box-shadow: 0 12px 30px var(--ombre);
            border: 1px solid rgba(79, 106, 106, 0.12);
        }

        h2 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.6rem, 1vw + 1.4rem, 2rem);
            color: var(--accent-fonce);
            margin: 0 0 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 span {
            display: inline-flex;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(156, 107, 79, 0.16);
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 0.95rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.92rem;
            letter-spacing: 0.02em;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(79, 106, 106, 0.18);
            border-radius: 12px;
            background: #fff;
            font-size: 0.98rem;
            transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(253, 249, 243, 0.9);
            box-shadow: 0 0 0 3px rgba(156, 107, 79, 0.18);
        }

        input[type="file"] {
            border: 2px dashed rgba(124, 82, 52, 0.35);
            background: rgba(253, 249, 243, 0.75);
            padding: 18px;
            border-radius: 16px;
            cursor: pointer;
        }

        .photo-preview {
            margin-top: 16px;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(55, 40, 24, 0.16);
            max-width: 200px;
            display: none;
            position: relative;
        }

        .photo-preview img {
            display: block;
            width: 100%;
            height: auto;
        }

        .title-suggestion {
            font-size: 0.9rem;
            color: var(--bleu);
            background: rgba(79, 106, 106, 0.12);
            padding: 10px 14px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            justify-content: flex-end;
            margin-top: 26px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 11px 26px;
            font-size: 0.96rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            font-family: inherit;
        }

        button.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-fonce));
            color: #fdf9f3;
            box-shadow: 0 8px 20px rgba(124, 82, 52, 0.25);
        }

        button.secondary {
            background: rgba(79, 106, 106, 0.12);
            color: var(--bleu);
        }

        button.danger {
            background: rgba(185, 91, 71, 0.14);
            color: #b55c45;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(55, 40, 24, 0.18);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 18px;
        }

        .filters input,
        .filters select {
            flex: 1 1 180px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--clair);
            border-radius: 16px;
            overflow: hidden;
            font-size: 0.95rem;
            border: 1px solid rgba(79, 106, 106, 0.12);
        }

        thead {
            background: rgba(79, 106, 106, 0.14);
            color: var(--bleu);
        }

        th,
        td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(47, 52, 55, 0.08);
            vertical-align: middle;
        }

        tbody tr:hover {
            background: rgba(156, 107, 79, 0.05);
        }

        .thumbnail {
            width: 58px;
            height: 58px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid rgba(47, 52, 55, 0.08);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 600;
        }

        .status.on-sale {
            background: rgba(111, 139, 116, 0.18);
            color: var(--vert);
        }

        .status.sold {
            background: rgba(156, 107, 79, 0.18);
            color: var(--accent-fonce);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(47, 42, 38, 0.6);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(79, 106, 106, 0.1), rgba(253, 249, 243, 0.65));
            border-radius: 18px;
            padding: 22px;
            border: 1px solid rgba(79, 106, 106, 0.14);
        }

        .stat-card h3 {
            margin: 0 0 10px;
            font-family: 'Playfair Display', serif;
            color: var(--accent-fonce);
        }

        .stat-value {
            font-size: 1.9rem;
            font-weight: 600;
            color: var(--bleu);
        }

        .stat-note {
            font-size: 0.85rem;
            color: rgba(47, 42, 38, 0.6);
            margin-top: 6px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(24, 20, 16, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10;
        }

        .modal-content {
            background: var(--clair);
            border-radius: 18px;
            padding: 26px;
            width: min(420px, 92vw);
            box-shadow: 0 20px 34px rgba(55, 40, 24, 0.22);
            position: relative;
            border: 1px solid rgba(79, 106, 106, 0.14);
        }

        .modal h3 {
            margin-top: 0;
            font-family: 'Playfair Display', serif;
            color: var(--accent-fonce);
        }

        .close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--bleu);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(79, 106, 106, 0.12);
            color: var(--bleu);
            font-size: 0.8rem;
            margin-right: 6px;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th, td {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Inventaire Vintage &amp; Revente</h1>
        <p>Gérez vos trésors chinés, suivez vos ventes et trouvez d'un coup d'œil le bon casier.
           L'application conserve vos données en local et vous aide à créer des fiches produits à partir d'une photo.</p>
    </header>

    <main class="container">
        <section class="card" aria-labelledby="ajout-objet">
            <h2 id="ajout-objet"><span>①</span>Nouvel objet</h2>
            <form id="itemForm">
                <div class="grid">
                    <div>
                        <label for="photo">Photo de l'objet</label>
                        <input type="file" id="photo" accept="image/*" required>
                        <div class="photo-preview" id="photoPreviewContainer">
                            <img id="photoPreview" alt="Prévisualisation de l'objet">
                        </div>
                        <div class="title-suggestion" id="titleSuggestion" hidden>
                            Suggestion automatique : <strong id="suggestedTitle"></strong>
                        </div>
                    </div>
                    <div>
                        <label for="casier">Casier / Emplacement</label>
                        <input type="text" id="casier" placeholder="Ex. A1, Bx1" required>

                        <label for="prixAchat">Prix d'achat (€)</label>
                        <input type="number" id="prixAchat" placeholder="0.00" min="0" step="0.01" required>

                        <label for="dateAchat">Date d'achat</label>
                        <input type="date" id="dateAchat" required>
                    </div>
                    <div>
                        <label for="titreAuto">Titre généré</label>
                        <input type="text" id="titreAuto" placeholder="En attente de la photo..." required>

                        <label for="notes">Notes (facultatif)</label>
                        <textarea id="notes" rows="6" placeholder="Détails complémentaires, état, provenance..."></textarea>
                    </div>
                </div>
                <div class="actions">
                    <button type="reset" class="secondary" id="resetForm">Effacer</button>
                    <button type="submit" class="primary">Ajouter à l'inventaire</button>
                </div>
            </form>
        </section>

        <section class="card" aria-labelledby="filtres-liste">
            <h2 id="filtres-liste"><span>②</span>Tableau de bord</h2>
            <div class="filters">
                <input type="search" id="searchInput" placeholder="Recherche rapide par titre...">
                <select id="filterCasier">
                    <option value="all">Tous les casiers</option>
                </select>
                <select id="filterPlateforme">
                    <option value="all">Toutes les plateformes</option>
                    <option value="eBay">eBay</option>
                    <option value="Vinted">Vinted</option>
                    <option value="Leboncoin">Leboncoin</option>
                    <option value="Autre">Autre</option>
                </select>
                <select id="filterStatus">
                    <option value="all">Tous les statuts</option>
                    <option value="available">Disponible</option>
                    <option value="sold">Vendu</option>
                </select>
                <button class="secondary" id="exportCsv" type="button">Exporter CSV</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Titre</th>
                            <th>Casier</th>
                            <th>Prix achat</th>
                            <th>Prix vente</th>
                            <th>Date achat</th>
                            <th>Date vente</th>
                            <th>Plateforme</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
                <div class="empty-state" id="emptyState" hidden>
                    Aucun objet pour le moment. Ajoutez votre premier trésor !
                </div>
            </div>
        </section>

        <section class="card" aria-labelledby="stats-globales">
            <h2 id="stats-globales"><span>③</span>Statistiques &amp; synthèse</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Objets en stock</h3>
                    <div class="stat-value" id="statEnStock">0</div>
                    <div class="stat-note">Encore disponibles à la vente</div>
                </div>
                <div class="stat-card">
                    <h3>Objets vendus</h3>
                    <div class="stat-value" id="statVendus">0</div>
                    <div class="stat-note">Total des fiches marquées "vendu"</div>
                </div>
                <div class="stat-card">
                    <h3>Chiffre d'affaires</h3>
                    <div class="stat-value" id="statCA">0 €</div>
                    <div class="stat-note">Somme de vos ventes renseignées</div>
                </div>
                <div class="stat-card">
                    <h3>Marge totale</h3>
                    <div class="stat-value" id="statMarge">0 €</div>
                    <div class="stat-note">Différence entre ventes et achats</div>
                </div>
            </div>
        </section>
    </main>

    <template id="rowTemplate">
        <tr>
            <td><img class="thumbnail" alt="Objet vintage"></td>
            <td class="col-title"></td>
            <td class="col-casier"></td>
            <td class="col-prix-achat"></td>
            <td class="col-prix-vente"></td>
            <td class="col-date-achat"></td>
            <td class="col-date-vente"></td>
            <td class="col-plateforme"></td>
            <td class="col-status"></td>
            <td class="col-actions"></td>
        </tr>
    </template>

    <template id="tagTemplate">
        <span class="tag"></span>
    </template>

    <div class="modal" id="saleModal" hidden role="dialog" aria-modal="true" aria-labelledby="saleModalTitle">
        <div class="modal-content">
            <button class="close-modal" id="closeModal" aria-label="Fermer">✕</button>
            <h3 id="saleModalTitle">Renseigner la vente</h3>
            <form id="saleForm">
                <input type="hidden" id="saleItemId">
                <div class="form-group">
                    <label for="salePrice">Prix de vente (€)</label>
                    <input type="number" id="salePrice" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="saleDate">Date de vente</label>
                    <input type="date" id="saleDate">
                </div>
                <div class="form-group">
                    <label for="salePlatform">Plateforme</label>
                    <select id="salePlatform">
                        <option value="eBay">eBay</option>
                        <option value="Vinted">Vinted</option>
                        <option value="Leboncoin">Leboncoin</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="actions">
                    <button type="button" class="secondary" id="markAvailable">Remettre en stock</button>
                    <button type="submit" class="primary">Valider</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0" defer></script>
    <script>
        const STORAGE_KEY = 'inventaire_vintage_items_v1';
        const DEFAULT_PLATFORM = 'Autre';
        let mobilenetModel = null;

        const elements = {
            form: document.getElementById('itemForm'),
            photoInput: document.getElementById('photo'),
            previewContainer: document.getElementById('photoPreviewContainer'),
            previewImage: document.getElementById('photoPreview'),
            suggestionWrapper: document.getElementById('titleSuggestion'),
            suggestionText: document.getElementById('suggestedTitle'),
            titreAuto: document.getElementById('titreAuto'),
            casier: document.getElementById('casier'),
            prixAchat: document.getElementById('prixAchat'),
            dateAchat: document.getElementById('dateAchat'),
            notes: document.getElementById('notes'),
            resetForm: document.getElementById('resetForm'),
            tableBody: document.getElementById('inventoryTableBody'),
            emptyState: document.getElementById('emptyState'),
            filterCasier: document.getElementById('filterCasier'),
            filterPlateforme: document.getElementById('filterPlateforme'),
            filterStatus: document.getElementById('filterStatus'),
            searchInput: document.getElementById('searchInput'),
            exportCsv: document.getElementById('exportCsv'),
            saleModal: document.getElementById('saleModal'),
            closeModal: document.getElementById('closeModal'),
            saleForm: document.getElementById('saleForm'),
            saleItemId: document.getElementById('saleItemId'),
            salePrice: document.getElementById('salePrice'),
            saleDate: document.getElementById('saleDate'),
            salePlatform: document.getElementById('salePlatform'),
            markAvailable: document.getElementById('markAvailable'),
            statEnStock: document.getElementById('statEnStock'),
            statVendus: document.getElementById('statVendus'),
            statCA: document.getElementById('statCA'),
            statMarge: document.getElementById('statMarge')
        };

        const state = {
            items: [],
            filters: {
                casier: 'all',
                plateforme: 'all',
                status: 'all',
                search: ''
            },
            pendingClassification: false
        };

        async function loadMobilenet() {
            try {
                mobilenetModel = await mobilenet.load();
                if (state.pendingClassification && elements.previewImage?.src) {
                    suggestTitle(elements.previewImage);
                }
            } catch (error) {
                console.warn('Impossible de charger le modèle de reconnaissance :', error);
                mobilenetModel = null;
                state.pendingClassification = false;
            }
        }

        function loadItems() {
            const stored = localStorage.getItem(STORAGE_KEY);
            state.items = stored ? JSON.parse(stored) : [];
        }

        function saveItems() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
        }

        function resetForm() {
            elements.form.reset();
            elements.previewContainer.style.display = 'none';
            elements.previewImage.src = '';
            delete elements.previewImage.dataset.imageData;
            elements.suggestionWrapper.hidden = true;
            elements.titreAuto.value = '';
            state.pendingClassification = false;
        }

        async function handlePhotoChange(event) {
            const file = event.target.files?.[0];
            if (!file) {
                elements.previewContainer.style.display = 'none';
                elements.suggestionWrapper.hidden = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                elements.previewContainer.style.display = 'block';
                elements.previewImage.src = dataUrl;
                elements.previewImage.onload = () => suggestTitle(elements.previewImage);
                elements.previewImage.dataset.imageData = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        function suggestTitle(imageEl) {
            if (!imageEl || !imageEl.complete) {
                return;
            }

            if (!mobilenetModel) {
                state.pendingClassification = true;
                if (!elements.titreAuto.value) {
                    elements.titreAuto.placeholder = 'Titre manuel (modèle en cours de chargement)';
                }
                elements.suggestionWrapper.hidden = true;
                return;
            }

            mobilenetModel.classify(imageEl).then(results => {
                if (!results || !results.length) {
                    elements.titreAuto.value = elements.titreAuto.value || 'Objet vintage unique';
                    elements.suggestionWrapper.hidden = true;
                    state.pendingClassification = false;
                    return;
                }
                const labels = results.slice(0, 3).map(r => r.className.split(',')[0].trim());
                const uniqueLabels = Array.from(new Set(labels));
                const suggestion = `Pièce vintage ${uniqueLabels.join(' & ')} - trouvé en brocante`;
                elements.titreAuto.value = suggestion;
                elements.suggestionText.textContent = suggestion;
                elements.suggestionWrapper.hidden = false;
                state.pendingClassification = false;
            }).catch(err => {
                console.warn('Classification impossible :', err);
                elements.titreAuto.value = elements.titreAuto.value || 'Objet vintage unique';
                elements.suggestionWrapper.hidden = true;
                state.pendingClassification = false;
            });
        }

        function createItemFromForm() {
            const photoData = elements.previewImage.dataset.imageData || null;
            return {
                id: crypto.randomUUID ? crypto.randomUUID() : `item-${Date.now()}`,
                titre: elements.titreAuto.value.trim() || 'Objet vintage',
                casier: elements.casier.value.trim(),
                prixAchat: Number(elements.prixAchat.value) || 0,
                dateAchat: elements.dateAchat.value,
                photoData,
                notes: elements.notes.value.trim(),
                vendu: false,
                prixVente: null,
                dateVente: '',
                plateforme: '',
                createdAt: new Date().toISOString()
            };
        }

        function addItem(item) {
            state.items.unshift(item);
            saveItems();
            render();
        }

        function updateItem(id, updates) {
            const index = state.items.findIndex(item => item.id === id);
            if (index === -1) return;
            state.items[index] = { ...state.items[index], ...updates };
            saveItems();
            render();
        }

        function applyFilters(items) {
            return items.filter(item => {
                const matchCasier = state.filters.casier === 'all' || item.casier === state.filters.casier;
                const matchPlateforme = state.filters.plateforme === 'all' || item.plateforme === state.filters.plateforme;
                const matchStatus = state.filters.status === 'all' ||
                    (state.filters.status === 'sold' && item.vendu) ||
                    (state.filters.status === 'available' && !item.vendu);
                const matchSearch = !state.filters.search || item.titre.toLowerCase().includes(state.filters.search.toLowerCase());
                return matchCasier && matchPlateforme && matchStatus && matchSearch;
            });
        }

        function renderFilters() {
            const uniqueCasiers = Array.from(new Set(state.items.map(item => item.casier))).sort();
            const options = '<option value="all">Tous les casiers</option>' +
                uniqueCasiers.map(c => `<option value="${c}">${c}</option>`).join('');
            elements.filterCasier.innerHTML = options;
            if (state.filters.casier !== 'all' && !uniqueCasiers.includes(state.filters.casier)) {
                state.filters.casier = 'all';
            }
            elements.filterCasier.value = state.filters.casier;
        }

        function renderTable() {
            const filtered = applyFilters(state.items);
            elements.tableBody.innerHTML = '';
            elements.emptyState.hidden = filtered.length !== 0;

            filtered.forEach(item => {
                const template = document.getElementById('rowTemplate');
                const row = template.content.firstElementChild.cloneNode(true);
                const img = row.querySelector('img');
                img.src = item.photoData || 'https://via.placeholder.com/80x80?text=Photo';
                img.alt = item.titre;

                row.querySelector('.col-title').innerHTML = `${item.titre}${item.notes ? `<br><small>${item.notes}</small>` : ''}`;
                row.querySelector('.col-casier').textContent = item.casier;
                row.querySelector('.col-prix-achat').textContent = item.prixAchat ? `${item.prixAchat.toFixed(2)} €` : '-';
                row.querySelector('.col-prix-vente').textContent = item.prixVente ? `${Number(item.prixVente).toFixed(2)} €` : '-';
                row.querySelector('.col-date-achat').textContent = item.dateAchat ? formatDate(item.dateAchat) : '-';
                row.querySelector('.col-date-vente').textContent = item.dateVente ? formatDate(item.dateVente) : '-';
                row.querySelector('.col-plateforme').textContent = item.plateforme || '-';

                const statusSpan = document.createElement('span');
                statusSpan.className = `status ${item.vendu ? 'sold' : 'on-sale'}`;
                statusSpan.textContent = item.vendu ? 'Vendu' : 'Disponible';
                row.querySelector('.col-status').appendChild(statusSpan);

                const actionsCell = row.querySelector('.col-actions');
                const saleBtn = document.createElement('button');
                saleBtn.className = 'secondary';
                saleBtn.type = 'button';
                saleBtn.textContent = item.vendu ? 'Modifier la vente' : 'Marquer comme vendu';
                saleBtn.addEventListener('click', () => openSaleModal(item));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'danger';
                deleteBtn.type = 'button';
                deleteBtn.textContent = 'Supprimer';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Supprimer cet objet de votre inventaire ?')) {
                        state.items = state.items.filter(i => i.id !== item.id);
                        saveItems();
                        render();
                    }
                });

                actionsCell.appendChild(saleBtn);
                actionsCell.appendChild(deleteBtn);

                elements.tableBody.appendChild(row);
            });
        }

        function renderStats() {
            const totalSold = state.items.filter(item => item.vendu);
            const totalStock = state.items.length - totalSold.length;
            const chiffreAffaires = totalSold.reduce((sum, item) => sum + (Number(item.prixVente) || 0), 0);
            const coutTotal = state.items.reduce((sum, item) => sum + (Number(item.prixAchat) || 0), 0);
            const marge = chiffreAffaires - coutTotal;

            elements.statEnStock.textContent = totalStock;
            elements.statVendus.textContent = totalSold.length;
            elements.statCA.textContent = `${chiffreAffaires.toFixed(2)} €`;
            elements.statMarge.textContent = `${marge.toFixed(2)} €`;
        }

        function render() {
            renderFilters();
            renderTable();
            renderStats();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function openSaleModal(item) {
            elements.saleModal.hidden = false;
            elements.saleItemId.value = item.id;
            elements.salePrice.value = item.prixVente ?? '';
            elements.saleDate.value = item.dateVente || '';
            elements.salePlatform.value = item.plateforme || DEFAULT_PLATFORM;
            elements.markAvailable.style.display = item.vendu ? 'inline-flex' : 'none';
        }

        function closeSaleModal() {
            elements.saleModal.hidden = true;
            elements.saleForm.reset();
        }

        function exportAsCsv() {
            if (!state.items.length) {
                alert('Aucune donnée à exporter.');
                return;
            }
            const headers = ['Titre', 'Casier', 'PrixAchat', 'PrixVente', 'DateAchat', 'DateVente', 'Plateforme', 'Vendu', 'Notes'];
            const rows = state.items.map(item => [
                wrapCsv(item.titre),
                wrapCsv(item.casier),
                item.prixAchat,
                item.prixVente ?? '',
                item.dateAchat,
                item.dateVente,
                wrapCsv(item.plateforme),
                item.vendu ? 'oui' : 'non',
                wrapCsv(item.notes)
            ].join(','));
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `inventaire-vintage-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function wrapCsv(value) {
            if (value == null) return '';
            const str = String(value).replace(/"/g, '""');
            return `"${str}"`;
        }

        elements.form.addEventListener('submit', (event) => {
            event.preventDefault();
            const item = createItemFromForm();
            if (!item.photoData) {
                alert('Merci d\'ajouter une photo pour générer la fiche.');
                return;
            }
            addItem(item);
            resetForm();
        });

        elements.resetForm.addEventListener('click', resetForm);
        elements.photoInput.addEventListener('change', handlePhotoChange);
        elements.filterCasier.addEventListener('change', (e) => {
            state.filters.casier = e.target.value;
            render();
        });
        elements.filterPlateforme.addEventListener('change', (e) => {
            state.filters.plateforme = e.target.value;
            render();
        });
        elements.filterStatus.addEventListener('change', (e) => {
            state.filters.status = e.target.value;
            render();
        });
        elements.searchInput.addEventListener('input', (e) => {
            state.filters.search = e.target.value;
            render();
        });
        elements.exportCsv.addEventListener('click', exportAsCsv);

        elements.closeModal.addEventListener('click', closeSaleModal);
        elements.saleModal.addEventListener('click', (event) => {
            if (event.target === elements.saleModal) {
                closeSaleModal();
            }
        });

        elements.saleForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = elements.saleItemId.value;
            const updates = {
                vendu: true,
                prixVente: elements.salePrice.value ? Number(elements.salePrice.value) : null,
                dateVente: elements.saleDate.value || '',
                plateforme: elements.salePlatform.value || DEFAULT_PLATFORM
            };
            updateItem(id, updates);
            closeSaleModal();
        });

        elements.markAvailable.addEventListener('click', () => {
            const id = elements.saleItemId.value;
            updateItem(id, {
                vendu: false,
                prixVente: null,
                dateVente: '',
                plateforme: ''
            });
            closeSaleModal();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            loadItems();
            render();
            await loadMobilenet();
        });
    </script>
</body>
</html>
