<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande express SEMPA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary: #ff7a00;
            --primary-dark: #d45f00;
            --success: #0f9d58;
            --danger: #d93025;
            --neutral-100: #f8fafc;
            --neutral-200: #e2e8f0;
            --neutral-600: #475569;
            --neutral-800: #1f2937;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #fff8f0, #f1f5f9 55%);
            color: var(--neutral-800);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
        }

        .form-wrapper {
            width: min(720px, 100%);
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 25px 55px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary), #ffab40);
            color: white;
            padding: 32px clamp(24px, 5vw, 48px);
        }

        header h1 {
            margin: 0 0 12px;
            font-size: clamp(26px, 4vw, 34px);
        }

        header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }

        form {
            padding: 32px clamp(24px, 5vw, 48px) 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: 15px;
            color: var(--neutral-800);
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        input,
        select,
        textarea {
            width: 100%;
            border: 1px solid var(--neutral-200);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.15);
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .quantity-control {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--neutral-200);
            border-radius: 999px;
            padding: 4px;
            width: 100%;
            max-width: 240px;
            background: var(--neutral-100);
        }

        .quantity-control input {
            border: none;
            text-align: center;
            width: 100%;
            max-width: 120px;
            font-weight: 600;
            background: transparent;
        }

        .quantity-control input:focus {
            box-shadow: none;
        }

        .qty-btn {
            background: white;
            border: none;
            border-radius: 999px;
            width: 44px;
            height: 44px;
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .qty-btn:active {
            transform: scale(0.97);
        }

        .qty-btn:hover,
        .qty-btn:focus-visible {
            background: rgba(255, 122, 0, 0.12);
            outline: none;
        }

        .helper-text {
            font-size: 13px;
            color: var(--neutral-600);
        }

        .error-message {
            min-height: 18px;
            font-size: 13px;
            color: var(--danger);
        }

        .form-feedback {
            display: none;
            margin-top: 24px;
            padding: 16px 18px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 15px;
        }

        .form-feedback.success {
            display: block;
            background: rgba(15, 157, 88, 0.1);
            color: var(--success);
            border: 1px solid rgba(15, 157, 88, 0.25);
        }

        .form-feedback.error {
            display: block;
            background: rgba(217, 48, 37, 0.08);
            color: var(--danger);
            border: 1px solid rgba(217, 48, 37, 0.25);
        }

        .form-actions {
            margin-top: 32px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .btn-primary,
        .btn-secondary {
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.01em;
            padding: 14px 32px;
            font-size: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            flex: 1 1 220px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 12px 24px rgba(255, 122, 0, 0.25);
        }

        .btn-primary:hover,
        .btn-primary:focus-visible {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--neutral-200);
            color: var(--neutral-800);
        }

        .btn-secondary:hover,
        .btn-secondary:focus-visible {
            background: #cbd5f5;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: progress;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            header {
                padding: 28px 24px;
            }

            form {
                padding: 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .quantity-control {
                max-width: none;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="form-wrapper">
    <header>
        <h1>Commande express</h1>
        <p>Remplissez les informations ci-dessous pour enregistrer rapidement une nouvelle commande dans l'ERP SEMPA.</p>
    </header>
    <form id="expressOrderForm" novalidate>
        <div class="form-grid">
            <div class="form-group">
                <label for="client_name" class="required">Nom / Société</label>
                <input type="text" id="client_name" name="client_name" autocomplete="name" required>
                <p class="error-message" data-error-for="client_name"></p>
            </div>
            <div class="form-group">
                <label for="email" class="required">Email</label>
                <input type="email" id="email" name="email" autocomplete="email" required>
                <p class="error-message" data-error-for="email"></p>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="phone" class="required">Téléphone</label>
                <input type="tel" id="phone" name="phone" autocomplete="tel" required>
                <p class="error-message" data-error-for="phone"></p>
            </div>
            <div class="form-group">
                <label for="product" class="required">Produit</label>
                <select id="product" name="product" required>
                    <option value="">Sélectionnez un produit…</option>
                    <option value="cartouche-orange">Cartouche orange 10L</option>
                    <option value="cartouche-fraise">Cartouche fraise 10L</option>
                    <option value="machine-sempa-500">Machine SEMPA 500</option>
                    <option value="kit-nettoyage">Kit nettoyage premium</option>
                </select>
                <p class="error-message" data-error-for="product"></p>
            </div>
        </div>

        <div class="form-group">
            <label for="quantity" class="required">Quantité</label>
            <div class="quantity-control" role="group" aria-label="Choisissez la quantité">
                <button type="button" class="qty-btn" data-step="-1" aria-label="Diminuer la quantité">−</button>
                <input type="number" id="quantity" name="quantity" inputmode="numeric" min="1" max="999" value="1" required>
                <button type="button" class="qty-btn" data-step="1" aria-label="Augmenter la quantité">+</button>
            </div>
            <p class="helper-text">Utilisez les boutons ou saisissez directement la quantité souhaitée.</p>
            <p class="error-message" data-error-for="quantity"></p>
        </div>

        <div class="form-group">
            <label for="notes">Commentaire (optionnel)</label>
            <textarea id="notes" name="notes" placeholder="Précisez par exemple une date de livraison, un contact sur site…"></textarea>
            <p class="error-message" data-error-for="notes"></p>
        </div>

        <div id="formFeedback" class="form-feedback" role="alert"></div>

        <div class="form-actions">
            <button type="reset" class="btn-secondary" id="resetButton">Réinitialiser</button>
            <button type="submit" class="btn-primary" id="submitButton">Valider la commande</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('expressOrderForm');
        const feedback = document.getElementById('formFeedback');
        const submitButton = document.getElementById('submitButton');
        const quantityInput = document.getElementById('quantity');
        const qtyButtons = document.querySelectorAll('.qty-btn');
        const emailInput = document.getElementById('email');

        const storedEmail = window.localStorage.getItem('commandeExpressEmail');
        if (storedEmail) {
            emailInput.value = storedEmail;
        }

        const errorMessages = {
            client_name: 'Merci de renseigner votre nom ou votre société.',
            email: 'Merci d\'indiquer une adresse email valide (ex : contact@exemple.fr).',
            phone: 'Merci de saisir un numéro de téléphone valide.',
            product: 'Sélectionnez le produit à commander.',
            quantity: 'La quantité doit être un nombre positif.',
        };

        const validators = {
            client_name: value => value.trim().length > 1,
            email: value => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(value.trim()),
            phone: value => value.trim().length >= 6,
            product: value => value.trim() !== '',
            quantity: value => {
                const number = Number(value);
                return Number.isInteger(number) && number >= 1 && number <= 999;
            },
        };

        const showError = (field, message) => {
            const errorElement = document.querySelector(`[data-error-for="${field.name}"]`);
            if (errorElement) {
                errorElement.textContent = message;
            }
            field.setAttribute('aria-invalid', 'true');
        };

        const clearError = field => {
            const errorElement = document.querySelector(`[data-error-for="${field.name}"]`);
            if (errorElement) {
                errorElement.textContent = '';
            }
            field.removeAttribute('aria-invalid');
        };

        const validateField = field => {
            const validator = validators[field.name];
            if (!validator) {
                return true;
            }
            const isValid = validator(field.value);
            if (!isValid) {
                showError(field, errorMessages[field.name]);
            } else {
                clearError(field);
            }
            return isValid;
        };

        form.addEventListener('input', event => {
            const field = event.target;
            if (field.name && validators[field.name]) {
                validateField(field);
            }
        });

        qtyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const step = Number(button.dataset.step);
                const currentValue = Number(quantityInput.value || 0);
                const nextValue = Math.min(Math.max(currentValue + step, 1), 999);
                quantityInput.value = nextValue;
                validateField(quantityInput);
            });
        });

        quantityInput.addEventListener('blur', () => {
            if (!validators.quantity(quantityInput.value)) {
                quantityInput.value = '1';
            }
            validateField(quantityInput);
        });

        form.addEventListener('reset', () => {
            window.setTimeout(() => {
                document.querySelectorAll('[data-error-for]').forEach(element => {
                    element.textContent = '';
                });
                feedback.className = 'form-feedback';
                feedback.textContent = '';
                submitButton.disabled = false;
                quantityInput.value = '1';
                emailInput.value = window.localStorage.getItem('commandeExpressEmail') || '';
            }, 0);
        });

        form.addEventListener('submit', async event => {
            event.preventDefault();

            let isFormValid = true;
            const requiredFields = ['client_name', 'email', 'phone', 'product', 'quantity'];
            requiredFields.forEach(name => {
                const field = form.elements.namedItem(name);
                if (!validateField(field)) {
                    isFormValid = false;
                }
            });

            if (!isFormValid) {
                feedback.textContent = 'Merci de corriger les erreurs ci-dessus avant de valider.';
                feedback.className = 'form-feedback error';
                return;
            }

            submitButton.disabled = true;
            feedback.className = 'form-feedback';
            feedback.textContent = '';

            const formData = new FormData(form);
            const emailValue = (formData.get('email') || '').toString().trim();

            try {
                const response = await fetch('process_commande.php', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    const message = result.message || 'Une erreur est survenue. Merci de réessayer.';
                    feedback.textContent = message;
                    feedback.className = 'form-feedback error';
                    const serverErrors = result.errors || {};
                    Object.entries(serverErrors).forEach(([name, errorMessage]) => {
                        const field = form.elements.namedItem(name);
                        if (field) {
                            showError(field, errorMessage);
                        }
                    });
                    submitButton.disabled = false;
                    return;
                }

                feedback.textContent = 'Merci ! Votre commande a été enregistrée avec succès.';
                feedback.className = 'form-feedback success';
                window.localStorage.setItem('commandeExpressEmail', emailValue);
                form.reset();
                submitButton.disabled = false;
            } catch (error) {
                console.error('Erreur lors de l\'envoi du formulaire', error);
                feedback.textContent = 'Impossible d\'enregistrer la commande pour le moment. Vérifiez votre connexion et réessayez.';
                feedback.className = 'form-feedback error';
                submitButton.disabled = false;
            }
        });

        emailInput.addEventListener('blur', () => {
            if (validators.email(emailInput.value)) {
                window.localStorage.setItem('commandeExpressEmail', emailInput.value.trim());
            }
        });
    });
</script>
</body>
</html>
